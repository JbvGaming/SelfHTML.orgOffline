<!DOCTYPE html>
<html lang="de-formal" dir="ltr" class="client-nojs">

<!-- Mirrored from wiki.selfhtml.org/wiki/PHP/Anwendung_und_Praxis/File_Upload by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 01 Mar 2015 22:32:19 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- /Added by HTTrack -->
<head>
<title>PHP/Anwendung und Praxis/File Upload – SELFHTML-Wiki</title>
<meta charset="UTF-8" />
<meta name="generator" content="MediaWiki 1.19.23" />
<link rel="alternate" type="application/x-wiki" title="Bearbeiten" href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit" />
<link rel="edit" title="Bearbeiten" href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit" />
<link rel="shortcut icon" href="http://src.selfhtml.org/favicon2.ico" />
<link rel="search" type="application/opensearchdescription+xml" href="http://wiki.selfhtml.org/opensearch_desc.php" title="SELFHTML-Wiki (de-formal)" />
<link rel="EditURI" type="application/rsd+xml" href="http://wiki.selfhtml.org/api.php?action=rsd" />
<link rel="copyright" href="http://creativecommons.org/licenses/by-sa/3.0/de/" />
<link rel="alternate" type="application/atom+xml" title="Atom-Feed für „SELFHTML-Wiki“" href="http://wiki.selfhtml.org/index.php?title=Spezial:Letzte_%C3%84nderungen&amp;feed=atom" />
<link rel="stylesheet" href="http://wiki.selfhtml.org/load.php?debug=false&amp;lang=de-formal&amp;modules=ext.geshi.local%7Cmediawiki.legacy.commonPrint%2Cshared%7Cskins.selfhtml&amp;only=styles&amp;skin=selfhtml&amp;*" />
<meta name="ResourceLoaderDynamicStyles" content="" />
<link rel="stylesheet" href="http://wiki.selfhtml.org/load.php?debug=false&amp;lang=de-formal&amp;modules=site&amp;only=styles&amp;skin=selfhtml&amp;*" />
<style>a:lang(ar),a:lang(ckb),a:lang(fa),a:lang(kk-arab),a:lang(mzn),a:lang(ps),a:lang(ur){text-decoration:none}a.new,#quickbar a.new{color:#ba0000}

/* cache key: webwiki:resourceloader:filter:minify-css:7:c88e2bcd56513749bec09a7e29cb3ffa */
</style>

<script src="http://wiki.selfhtml.org/load.php?debug=false&amp;lang=de-formal&amp;modules=startup&amp;only=scripts&amp;skin=selfhtml&amp;*"></script>
<script>if(window.mw){
mw.config.set({"wgCanonicalNamespace":"","wgCanonicalSpecialPageName":false,"wgNamespaceNumber":0,"wgPageName":"PHP/Anwendung_und_Praxis/File_Upload","wgTitle":"PHP/Anwendung und Praxis/File Upload","wgCurRevisionId":24607,"wgArticleId":761,"wgIsArticle":true,"wgAction":"view","wgUserName":null,"wgUserGroups":["*"],"wgCategories":["ToDo","PHP"],"wgBreakFrames":false,"wgPageContentLanguage":"de-formal","wgSeparatorTransformTable":[",	.",".	,"],"wgDigitTransformTable":["",""],"wgRelevantPageName":"PHP/Anwendung_und_Praxis/File_Upload","wgRestrictionEdit":[],"wgRestrictionMove":[],"wgSearchNamespaces":[0,100,110,120,130,140,180,190],"wgVectorEnabledModules":{"collapsiblenav":true,"collapsibletabs":true,"editwarning":false,"expandablesearch":false,"footercleanup":false,"sectioneditlinks":false,"simplesearch":true,"experiments":true},"wgWikiEditorEnabledModules":{"toolbar":false,"dialogs":false,"hidesig":true,"templateEditor":false,"templates":false,"preview":false,"previewDialog":false,"publish":false,"toc":false},"sfgAutocompleteValues":[],"sfgAutocompleteOnAllChars":false,"sfgFieldProperties":[],"sfgDependentFields":[],"sfgShowOnSelect":[],"sfgScriptPath":"/extensions/SemanticForms","wgCategoryTreePageCategoryOptions":"{\"mode\":0,\"hideprefix\":20,\"showcount\":true,\"namespaces\":false}"});
}</script><script>if(window.mw){
mw.loader.implement("user.options",function($){mw.user.options.set({"ccmeonemails":0,"cols":80,"date":"default","diffonly":0,"disablemail":0,"disablesuggest":0,"editfont":"default","editondblclick":0,"editsection":1,"editsectiononrightclick":0,"enotifminoredits":0,"enotifrevealaddr":0,"enotifusertalkpages":1,"enotifwatchlistpages":0,"extendwatchlist":0,"externaldiff":0,"externaleditor":0,"fancysig":0,"forceeditsummary":0,"gender":"unknown","hideminor":0,"hidepatrolled":0,"highlightbroken":1,"imagesize":2,"justify":0,"math":1,"minordefault":0,"newpageshidepatrolled":0,"nocache":0,"noconvertlink":0,"norollbackdiff":0,"numberheadings":0,"previewonfirst":0,"previewontop":1,"quickbar":5,"rcdays":7,"rclimit":50,"rememberpassword":0,"rows":25,"searchlimit":20,"showhiddencats":0,"showjumplinks":1,"shownumberswatching":1,"showtoc":1,"showtoolbar":1,"skin":"selfhtml","stubthreshold":0,"thumbsize":2,"underline":2,"uselivepreview":0,"usenewrc":0,"watchcreations":0,"watchdefault":0,"watchdeletion":
0,"watchlistdays":3,"watchlisthideanons":0,"watchlisthidebots":0,"watchlisthideliu":0,"watchlisthideminor":0,"watchlisthideown":0,"watchlisthidepatrolled":0,"watchmoves":0,"wllimit":250,"vector-simplesearch":1,"variant":"de-formal","language":"de-formal","searchNs0":true,"searchNs1":false,"searchNs2":false,"searchNs3":false,"searchNs4":false,"searchNs5":false,"searchNs6":false,"searchNs7":false,"searchNs8":false,"searchNs9":false,"searchNs10":false,"searchNs11":false,"searchNs12":false,"searchNs13":false,"searchNs14":false,"searchNs15":false,"searchNs100":true,"searchNs101":false,"searchNs102":false,"searchNs103":false,"searchNs110":true,"searchNs111":false,"searchNs120":true,"searchNs121":false,"searchNs130":true,"searchNs131":false,"searchNs140":true,"searchNs141":false,"searchNs180":true,"searchNs181":false,"searchNs190":true,"searchNs191":false,"searchNs202":false,"searchNs203":false,"searchNs206":false,"searchNs207":false,"searchNs208":false,"searchNs209":false});;},{},{});mw.
loader.implement("user.tokens",function($){mw.user.tokens.set({"editToken":"+\\","watchToken":false});;},{},{});

/* cache key: webwiki:resourceloader:filter:minify-js:7:b3c411f6995359b137cf90aee10cf1e1 */
}</script>
<script>if(window.mw){
mw.loader.load(["mediawiki.page.startup","mediawiki.legacy.wikibits","mediawiki.legacy.ajax"]);
}</script>
<style type="text/css">/*<![CDATA[*/
.source-apache {line-height: normal;}
.source-apache li, .source-apache pre {
	line-height: normal; border: 0px none white;
}
/**
 * GeSHi Dynamically Generated Stylesheet
 * --------------------------------------
 * Dynamically generated stylesheet for apache
 * CSS class: source-apache, CSS id: 
 * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2008 Benny Baumann
 * (http://qbnz.com/highlighter/ and http://geshi.org/)
 * --------------------------------------
 */
.apache.source-apache .de1, .apache.source-apache .de2 {font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;}
.apache.source-apache  {font-family:monospace;}
.apache.source-apache .imp {font-weight: bold; color: red;}
.apache.source-apache li, .apache.source-apache .li1 {font-weight: normal; vertical-align:top;}
.apache.source-apache .ln {width:1px;text-align:right;margin:0;padding:0 2px;vertical-align:top;}
.apache.source-apache .li2 {font-weight: bold; vertical-align:top;}
.apache.source-apache .kw1 {color: #00007f;}
.apache.source-apache .kw2 {color: #0000ff;}
.apache.source-apache .kw3 {color: #000000; font-weight:bold;}
.apache.source-apache .co1 {color: #adadad; font-style: italic;}
.apache.source-apache .es0 {color: #000099; font-weight: bold;}
.apache.source-apache .br0 {color: #339933;}
.apache.source-apache .sy0 {color: #008000;}
.apache.source-apache .st0 {color: #7f007f;}
.apache.source-apache .nu0 {color: #ff0000;}
.apache.source-apache .ln-xtra, .apache.source-apache li.ln-xtra, .apache.source-apache div.ln-xtra {background-color: #ffc;}
.apache.source-apache span.xtra { display:block; }

/*]]>*/
</style><style type="text/css">/*<![CDATA[*/
.source-php {line-height: normal;}
.source-php li, .source-php pre {
	line-height: normal; border: 0px none white;
}
/**
 * GeSHi Dynamically Generated Stylesheet
 * --------------------------------------
 * Dynamically generated stylesheet for php
 * CSS class: source-php, CSS id: 
 * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2008 Benny Baumann
 * (http://qbnz.com/highlighter/ and http://geshi.org/)
 * --------------------------------------
 */
.php.source-php .de1, .php.source-php .de2 {font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;}
.php.source-php  {font-family:monospace;}
.php.source-php .imp {font-weight: bold; color: red;}
.php.source-php li, .php.source-php .li1 {font-weight: normal; vertical-align:top;}
.php.source-php .ln {width:1px;text-align:right;margin:0;padding:0 2px;vertical-align:top;}
.php.source-php .li2 {font-weight: bold; vertical-align:top;}
.php.source-php .kw1 {color: #b1b100;}
.php.source-php .kw2 {color: #000000; font-weight: bold;}
.php.source-php .kw3 {color: #990000;}
.php.source-php .kw4 {color: #009900; font-weight: bold;}
.php.source-php .co1 {color: #666666; font-style: italic;}
.php.source-php .co2 {color: #666666; font-style: italic;}
.php.source-php .co3 {color: #0000cc; font-style: italic;}
.php.source-php .co4 {color: #009933; font-style: italic;}
.php.source-php .coMULTI {color: #666666; font-style: italic;}
.php.source-php .es0 {color: #000099; font-weight: bold;}
.php.source-php .es1 {color: #000099; font-weight: bold;}
.php.source-php .es2 {color: #660099; font-weight: bold;}
.php.source-php .es3 {color: #660099; font-weight: bold;}
.php.source-php .es4 {color: #006699; font-weight: bold;}
.php.source-php .es5 {color: #006699; font-weight: bold; font-style: italic;}
.php.source-php .es6 {color: #009933; font-weight: bold;}
.php.source-php .es_h {color: #000099; font-weight: bold;}
.php.source-php .br0 {color: #009900;}
.php.source-php .sy0 {color: #339933;}
.php.source-php .sy1 {color: #000000; font-weight: bold;}
.php.source-php .st0 {color: #0000ff;}
.php.source-php .st_h {color: #0000ff;}
.php.source-php .nu0 {color: #cc66cc;}
.php.source-php .nu8 {color: #208080;}
.php.source-php .nu12 {color: #208080;}
.php.source-php .nu19 {color:#800080;}
.php.source-php .me1 {color: #004000;}
.php.source-php .me2 {color: #004000;}
.php.source-php .re0 {color: #000088;}
.php.source-php .ln-xtra, .php.source-php li.ln-xtra, .php.source-php div.ln-xtra {background-color: #ffc;}
.php.source-php span.xtra { display:block; }

/*]]>*/
</style><style type="text/css">/*<![CDATA[*/
.source-bash {line-height: normal;}
.source-bash li, .source-bash pre {
	line-height: normal; border: 0px none white;
}
/**
 * GeSHi Dynamically Generated Stylesheet
 * --------------------------------------
 * Dynamically generated stylesheet for bash
 * CSS class: source-bash, CSS id: 
 * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2008 Benny Baumann
 * (http://qbnz.com/highlighter/ and http://geshi.org/)
 * --------------------------------------
 */
.bash.source-bash .de1, .bash.source-bash .de2 {font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;}
.bash.source-bash  {font-family:monospace;}
.bash.source-bash .imp {font-weight: bold; color: red;}
.bash.source-bash li, .bash.source-bash .li1 {font-weight: normal; vertical-align:top;}
.bash.source-bash .ln {width:1px;text-align:right;margin:0;padding:0 2px;vertical-align:top;}
.bash.source-bash .li2 {font-weight: bold; vertical-align:top;}
.bash.source-bash .kw1 {color: #000000; font-weight: bold;}
.bash.source-bash .kw2 {color: #c20cb9; font-weight: bold;}
.bash.source-bash .kw3 {color: #7a0874; font-weight: bold;}
.bash.source-bash .co0 {color: #666666; font-style: italic;}
.bash.source-bash .co1 {color: #800000;}
.bash.source-bash .co2 {color: #cc0000; font-style: italic;}
.bash.source-bash .co3 {color: #000000; font-weight: bold;}
.bash.source-bash .co4 {color: #666666;}
.bash.source-bash .es1 {color: #000099; font-weight: bold;}
.bash.source-bash .es2 {color: #007800;}
.bash.source-bash .es3 {color: #007800;}
.bash.source-bash .es4 {color: #007800;}
.bash.source-bash .es5 {color: #780078;}
.bash.source-bash .es_h {color: #000099; font-weight: bold;}
.bash.source-bash .br0 {color: #7a0874; font-weight: bold;}
.bash.source-bash .sy0 {color: #000000; font-weight: bold;}
.bash.source-bash .st0 {color: #ff0000;}
.bash.source-bash .st_h {color: #ff0000;}
.bash.source-bash .nu0 {color: #000000;}
.bash.source-bash .re0 {color: #007800;}
.bash.source-bash .re1 {color: #007800;}
.bash.source-bash .re2 {color: #007800;}
.bash.source-bash .re4 {color: #007800;}
.bash.source-bash .re5 {color: #660033;}
.bash.source-bash .ln-xtra, .bash.source-bash li.ln-xtra, .bash.source-bash div.ln-xtra {background-color: #ffc;}
.bash.source-bash span.xtra { display:block; }

/*]]>*/
</style><style type="text/css">/*<![CDATA[*/
.source-html5 {line-height: normal;}
.source-html5 li, .source-html5 pre {
	line-height: normal; border: 0px none white;
}
/**
 * GeSHi Dynamically Generated Stylesheet
 * --------------------------------------
 * Dynamically generated stylesheet for html5
 * CSS class: source-html5, CSS id: 
 * GeSHi (C) 2004 - 2007 Nigel McNie, 2007 - 2008 Benny Baumann
 * (http://qbnz.com/highlighter/ and http://geshi.org/)
 * --------------------------------------
 */
.html5.source-html5 .de1, .html5.source-html5 .de2 {font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;}
.html5.source-html5  {font-family:monospace;}
.html5.source-html5 .imp {font-weight: bold; color: red;}
.html5.source-html5 li, .html5.source-html5 .li1 {font-weight: normal; vertical-align:top;}
.html5.source-html5 .ln {width:1px;text-align:right;margin:0;padding:0 2px;vertical-align:top;}
.html5.source-html5 .li2 {font-weight: bold; vertical-align:top;}
.html5.source-html5 .kw2 {color: #000000; font-weight: bold;}
.html5.source-html5 .kw3 {color: #000066;}
.html5.source-html5 .es0 {color: #000099; font-weight: bold;}
.html5.source-html5 .br0 {color: #66cc66;}
.html5.source-html5 .sy0 {color: #66cc66;}
.html5.source-html5 .st0 {color: #ff0000;}
.html5.source-html5 .nu0 {color: #cc66cc;}
.html5.source-html5 .sc-2 {color: #404040;}
.html5.source-html5 .sc-1 {color: #808080; font-style: italic;}
.html5.source-html5 .sc0 {color: #00bbdd;}
.html5.source-html5 .sc1 {color: #ddbb00;}
.html5.source-html5 .sc2 {color: #009900;}
.html5.source-html5 .ln-xtra, .html5.source-html5 li.ln-xtra, .html5.source-html5 div.ln-xtra {background-color: #ffc;}
.html5.source-html5 span.xtra { display:block; }

/*]]>*/
</style>		<link rel="alternate" type="application/rdf+xml" title="PHP/Anwendung und Praxis/File Upload" href="http://wiki.selfhtml.org/index.php?title=Spezial:RDF_exportieren/PHP/Anwendung_und_Praxis/File_Upload&amp;xmlmime=rdf" />
<!--[if lt IE 7]><style type="text/css">body{behavior:url("/skins/selfhtml/csshover.min.htc")}</style><![endif]--><meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body class="mediawiki ltr sitedir-ltr capitalize-all-nouns ns-0 ns-subject page-PHP_Anwendung_und_Praxis_File_Upload skin-selfhtml action-view">
		<div id="mw-page-base" class="noprint"></div>
		<div id="mw-head-base" class="noprint"></div>
		<!-- content -->
		<div id="content" class="mw-body">
			<a id="top"></a>
			<div id="mw-js-message" style="display:none;"></div>
						<!-- firstHeading -->
			<h1 id="firstHeading" class="firstHeading">
				<span dir="auto">PHP/Anwendung und Praxis/File Upload</span>
			</h1>
			<!-- /firstHeading -->
			<!-- bodyContent -->
			<div id="bodyContent">
								<!-- tagline -->
				<div id="siteSub">Aus SELFHTML-Wiki</div>
				<!-- /tagline -->
								<!-- subtitle -->
				<div id="contentSub"><span class="subpages">&lt; <a href="http://wiki.selfhtml.org/wiki/PHP" title="PHP">PHP</a> | <a href="http://wiki.selfhtml.org/wiki/PHP/Anwendung_und_Praxis" title="PHP/Anwendung und Praxis">Anwendung und Praxis</a></span></div>
				<!-- /subtitle -->
																<!-- jumpto -->
				<div id="jump-to-nav" class="mw-jump">
					Wechseln zu: <a href="#mw-head">Navigation</a>,
					<a href="#p-search">Suche</a>
				</div>
				<!-- /jumpto -->
								<!-- bodycontent -->
				<div id="mw-content-text" lang="de-formal" dir="ltr" class="mw-content-ltr"><p>In vielen Situationen erscheint es notwendig, mittels HTML-Formular auch Dateien an den Server zu übertragen, also sogenannte Uploads durchzuführen. Hierbei kann es sich um Bilder zum Text, um mitzuliefernde Textdateien, Office-Dokumente oder auch HTML-Seiten oder sogar ausführbare Scripte handeln. Beliebige andere Datenfiles sind denkbar.
</p><p>Oft wird dabei leider übersehen, dass man sich durch die Bereitstellung eines File-Uploads eine Sicherheitslücke in seinen Server reißen kann.
</p><p>Dieser Artikel soll daher <b>NICHT</b> zeigen, wie man <i>mal eben schnell</i> einen Fileupload in seine Webseiten einbaut, sondern <b>WARUM MAN NICHT MAL EBEN SCHNELL</b> ein Loch in seinem Server reißen sollte, indem man sich kurzsichtig ein <i>"Uploadscript"</i> aus dubiosen Quellen zusammenkopiert. 
</p><p>Die Fertigstellung dieses Artikels dauert auch etwas länger, da es bisher kaum öffentliche Quellen zu den möglichen Löchern im System gibt und täglich neue Anregungen hinzu kommen. Alles, was hier aber bisher geschrieben steht, lohnt sich. gelesen zu werden - auch wenn sich vielleicht im Wandel des Artilkels manche Überlegungen schon wieder erledigt haben sollten.
</p><p>Ich werde mich bemühen, nicht nur die "Uploadseite" zu zeigen, sondern auch praktische Beispiele für die anschließende "Downloadseite", weil man die Problematiken nicht voneinander trennen darf!
</p><p><br />
</p>
<table id="toc" class="toc"><tr><td><div id="toctitle"><h2>Inhaltsverzeichnis</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Verfahren"><span class="tocnumber">1</span> <span class="toctext">Verfahren</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#POST_f.C3.BCr_eine_Datei"><span class="tocnumber">1.1</span> <span class="toctext">POST für eine Datei</span></a>
<ul>
<li class="toclevel-3 tocsection-3"><a href="#Client"><span class="tocnumber">1.1.1</span> <span class="toctext">Client</span></a></li>
<li class="toclevel-3 tocsection-4"><a href="#Server"><span class="tocnumber">1.1.2</span> <span class="toctext">Server</span></a></li>
<li class="toclevel-3 tocsection-5"><a href="#Verzeichnisstruktur"><span class="tocnumber">1.1.3</span> <span class="toctext">Verzeichnisstruktur</span></a></li>
<li class="toclevel-3 tocsection-6"><a href="#POST_auswerten"><span class="tocnumber">1.1.4</span> <span class="toctext">POST auswerten</span></a></li>
<li class="toclevel-3 tocsection-7"><a href="#Error-Codes_des_Uploads"><span class="tocnumber">1.1.5</span> <span class="toctext">Error-Codes des Uploads</span></a></li>
<li class="toclevel-3 tocsection-8"><a href="#Der_Parameter_MAX_FILE_SIZE"><span class="tocnumber">1.1.6</span> <span class="toctext">Der Parameter MAX_FILE_SIZE</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-9"><a href="#Post_mit_mehreren_Dateien"><span class="tocnumber">1.2</span> <span class="toctext">Post mit mehreren Dateien</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-10"><a href="#Sicherheit"><span class="tocnumber">2</span> <span class="toctext">Sicherheit</span></a>
<ul>
<li class="toclevel-2 tocsection-11"><a href="#Sauberen_Upload_erkennen"><span class="tocnumber">2.1</span> <span class="toctext">Sauberen Upload erkennen</span></a></li>
<li class="toclevel-2 tocsection-12"><a href="#MIME-Type_erkennen"><span class="tocnumber">2.2</span> <span class="toctext">MIME-Type erkennen</span></a>
<ul>
<li class="toclevel-3 tocsection-13"><a href="#Bilder_erkennen"><span class="tocnumber">2.2.1</span> <span class="toctext">Bilder erkennen</span></a>
<ul>
<li class="toclevel-4 tocsection-14"><a href="#Der_Wert_von_getimagesize.28.29"><span class="tocnumber">2.2.1.1</span> <span class="toctext">Der Wert von getimagesize()</span></a></li>
</ul>
</li>
<li class="toclevel-3 tocsection-15"><a href="#Textdateien_erkennen"><span class="tocnumber">2.2.2</span> <span class="toctext">Textdateien erkennen</span></a>
<ul>
<li class="toclevel-4 tocsection-16"><a href="#Einfache_Textformate"><span class="tocnumber">2.2.2.1</span> <span class="toctext">Einfache Textformate</span></a></li>
<li class="toclevel-4 tocsection-17"><a href="#H.C3.B6here_Textformate"><span class="tocnumber">2.2.2.2</span> <span class="toctext">Höhere Textformate</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-2 tocsection-18"><a href="#Sch.C3.A4dliche_Dateinamen_ausschlie.C3.9Fen"><span class="tocnumber">2.3</span> <span class="toctext">Schädliche Dateinamen ausschließen</span></a>
<ul>
<li class="toclevel-3 tocsection-19"><a href="#F.C3.BCr_Windows-Zielsysteme_gilt"><span class="tocnumber">2.3.1</span> <span class="toctext">Für Windows-Zielsysteme gilt</span></a></li>
<li class="toclevel-3 tocsection-20"><a href="#F.C3.BCr_Linux-Zielsysteme_gilt"><span class="tocnumber">2.3.2</span> <span class="toctext">Für Linux-Zielsysteme gilt</span></a></li>
<li class="toclevel-3 tocsection-21"><a href="#F.C3.BCr_PHP_gilt_zus.C3.A4tzlich"><span class="tocnumber">2.3.3</span> <span class="toctext">Für PHP gilt zusätzlich</span></a></li>
<li class="toclevel-3 tocsection-22"><a href="#F.C3.BCr_den_Apache_Webserver_gilt"><span class="tocnumber">2.3.4</span> <span class="toctext">Für den Apache Webserver gilt</span></a></li>
<li class="toclevel-3 tocsection-23"><a href="#Dateinamen_anpassen"><span class="tocnumber">2.3.5</span> <span class="toctext">Dateinamen anpassen</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-24"><a href="#Scripte_verhindern"><span class="tocnumber">2.4</span> <span class="toctext">Scripte verhindern</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-25"><a href="#Sichern_von_Uploads"><span class="tocnumber">3</span> <span class="toctext">Sichern von Uploads</span></a>
<ul>
<li class="toclevel-2 tocsection-26"><a href="#Konfigurationseinstellungen"><span class="tocnumber">3.1</span> <span class="toctext">Konfigurationseinstellungen</span></a></li>
<li class="toclevel-2 tocsection-27"><a href="#Kontrolliert_speichern"><span class="tocnumber">3.2</span> <span class="toctext">Kontrolliert speichern</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-28"><a href="#Dateien_bereitstellen"><span class="tocnumber">4</span> <span class="toctext">Dateien bereitstellen</span></a>
<ul>
<li class="toclevel-2 tocsection-29"><a href="#innerhalb_der_Document_Root"><span class="tocnumber">4.1</span> <span class="toctext">innerhalb der Document Root</span></a>
<ul>
<li class="toclevel-3 tocsection-30"><a href="#Script-Ausf.C3.BChrung_abschalten"><span class="tocnumber">4.1.1</span> <span class="toctext">Script-Ausführung abschalten</span></a></li>
<li class="toclevel-3 tocsection-31"><a href="#Hochladen_sch.C3.A4dlicher_Dateien_unterbinden"><span class="tocnumber">4.1.2</span> <span class="toctext">Hochladen schädlicher Dateien unterbinden</span></a></li>
</ul>
</li>
<li class="toclevel-2 tocsection-32"><a href="#au.C3.9Ferhalb_der_Document_Root"><span class="tocnumber">4.2</span> <span class="toctext">außerhalb der Document Root</span></a></li>
<li class="toclevel-2 tocsection-33"><a href="#in_Datenbanken_speichern"><span class="tocnumber">4.3</span> <span class="toctext">in Datenbanken speichern</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-34"><a href="#Typische_Sicherheitsl.C3.BCcken"><span class="tocnumber">5</span> <span class="toctext">Typische Sicherheitslücken</span></a></li>
<li class="toclevel-1 tocsection-35"><a href="#Workflow"><span class="tocnumber">6</span> <span class="toctext">Workflow</span></a>
<ul>
<li class="toclevel-2 tocsection-36"><a href="#Schritt_f.C3.BCr_Schritt_zum_Ziel"><span class="tocnumber">6.1</span> <span class="toctext">Schritt für Schritt zum Ziel</span></a></li>
<li class="toclevel-2 tocsection-37"><a href="#Dialog-Elemente_und_File-Upload_kombinieren"><span class="tocnumber">6.2</span> <span class="toctext">Dialog-Elemente und File-Upload kombinieren</span></a></li>
<li class="toclevel-2 tocsection-38"><a href="#Sessions_nutzen_f.C3.BCr_den_File-Upload"><span class="tocnumber">6.3</span> <span class="toctext">Sessions nutzen für den File-Upload</span></a></li>
<li class="toclevel-2 tocsection-39"><a href="#Multiupload_per_JavaScript_unterst.C3.BCtzen"><span class="tocnumber">6.4</span> <span class="toctext">Multiupload per JavaScript unterstützen</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-40"><a href="#Hochgeladene_Inhalte_gesichert_bereitstellen"><span class="tocnumber">7</span> <span class="toctext">Hochgeladene Inhalte gesichert bereitstellen</span></a>
<ul>
<li class="toclevel-2 tocsection-41"><a href="#URL-Parameter_contra_URL-Rewriting_.28mod_rewrite.29"><span class="tocnumber">7.1</span> <span class="toctext">URL-Parameter contra URL-Rewriting (mod_rewrite)</span></a></li>
<li class="toclevel-2 tocsection-42"><a href="#Bilder_ausliefern_per_Script"><span class="tocnumber">7.2</span> <span class="toctext">Bilder ausliefern per Script</span></a></li>
<li class="toclevel-2 tocsection-43"><a href="#Files_bereitstellen_per_Script"><span class="tocnumber">7.3</span> <span class="toctext">Files bereitstellen per Script</span></a></li>
<li class="toclevel-2 tocsection-44"><a href="#Unkontrollierter_Zugriff"><span class="tocnumber">7.4</span> <span class="toctext">Unkontrollierter Zugriff</span></a></li>
<li class="toclevel-2 tocsection-45"><a href="#Bedingter_Zugriff"><span class="tocnumber">7.5</span> <span class="toctext">Bedingter Zugriff</span></a></li>
<li class="toclevel-2 tocsection-46"><a href="#Bedingter_Zugriff_mit_spezifischen_Benutzerrechten"><span class="tocnumber">7.6</span> <span class="toctext">Bedingter Zugriff mit spezifischen Benutzerrechten</span></a></li>
<li class="toclevel-2 tocsection-47"><a href="#Kontrolle_per_Sessiondaten_contra_Datenbankabfrage"><span class="tocnumber">7.7</span> <span class="toctext">Kontrolle per Sessiondaten contra Datenbankabfrage</span></a></li>
<li class="toclevel-2 tocsection-48"><a href="#Large_Objects_aus_der_Datenbank_bereitstellen"><span class="tocnumber">7.8</span> <span class="toctext">Large Objects aus der Datenbank bereitstellen</span></a></li>
</ul>
</li>
</ul>
</td></tr></table>
<h2><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=1" title="Abschnitt bearbeiten: Verfahren">Bearbeiten</a>]</span> <span class="mw-headline" id="Verfahren">Verfahren</span></h2>
<h3><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=2" title="Abschnitt bearbeiten: POST für eine Datei">Bearbeiten</a>]</span> <span class="mw-headline" id="POST_f.C3.BCr_eine_Datei">POST für eine Datei</span></h3>
<p>Die Übermittlung findet in der Regel mit den Protokollen <a href="http://wiki.selfhtml.org/wiki/Glossar:HTTP" title="Glossar:HTTP" class="mw-redirect">HTTP</a> oder <a href="http://wiki.selfhtml.org/wiki/Grundlagen/HTTPS_und_SSL" title="Grundlagen/HTTPS und SSL">HTTPS</a> statt. Für beide Protokolle stehen zwei Methoden (POST, PUT) zur Verfügung, von denen meistens nur die POST-Methode implementiert ist.
</p>
<h4><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=3" title="Abschnitt bearbeiten: Client">Bearbeiten</a>]</span> <span class="mw-headline" id="Client">Client</span></h4>
<p>Bei der Post-Methode verpackt der Browser alle zu übermittelnden Daten in einem Post-Request. Zur Übermittlung von Files benötigt PHP hier auf der Server-Seite den MIME-Encryption-Type <code>multipart/form-data</code>, sodass man den Browser auch auf der Client-Seite anweisen muss, diesen zu benutzen.
</p><p>In einer validen HTML-Seite notiert man dazu ein <code>&lt;form&gt;</code>-Element, das seinerseits das <code>&lt;input&gt;</code>-Element vom Typ <code>file</code> enthält. Es fehlt nun nur noch die Möglichkeit, die Übertragung auszulösen. Dies geschieht am einfachsten durch Hinzufügen eines <code>&lt;input&gt;</code>-Elementes vom Typ <code>submit</code>. Mehr ist auf der Clientseite nicht notwendig.
</p>
<ul><li> Benötigte Elemente
<ul><li> &lt;form&gt;
<ul><li> <code>action</code>
</li><li> <code>method</code>
</li><li> <code>enctype</code>
</li></ul>
</li><li> &lt;input&gt;
<ul><li> Typ <b>file</b> mit Attribut <code>name</code>
</li><li> Typ <b>submit</b> mit Attribut <code>name</code>
</li></ul>
</li></ul>
</li></ul>
<div class="note-box note-box-example vorlage_beispiel">
<div class="note-box-title">Beispiel
</div>
<div class="note-box-text note-box-example-comment">Ausschnitt aus dem HTML-Formular:</div>
<div class="note-box-text note-box-example-code">&lt;form <b>action</b>=&quot;upload.php&quot; <b>method</b>=&quot;post&quot; <b>enctype</b>=&quot;multipart/form-data&quot;&gt;
    &lt;input <b>type="file"</b> name=&quot;dateiupload&quot;&gt;
    &lt;input <b>type="submit"</b> name=&quot;btn[upload]&quot;&gt;
&lt;/form&gt;</div>
<div class="note-box-text note-box-example-comment">So sieht es im Browserfenster aus:</div>
<div class="note-box-text note-box-example-wiki"><a href="http://wiki.selfhtml.org/wiki/Datei:PHP_Upload-Formular.jpg" class="image"><img alt="PHP Upload-Formular.jpg" src="http://wiki.selfhtml.org/images/0/0b/PHP_Upload-Formular.jpg" width="502" height="225" /></a></div>
<div class="note-box-text note-box-example-comment">Der Firefox-Browser erzeugt ein Eingabefeld, einen Durchsuchen-Button und einen Button mit der Beschriftung „Daten absenden“. Diesen Text ergänzt er selbsttätig, weil wir kein Value-Attribut für den Button angebegen haben.
Mit einem <code>value="mein_Text"</code> kann man dem Submit-Button auch einen eigenen Text zuweisen.</div>
<div class="note-box-text note-box-example-comment">Das macht der Browser beim Absenden daraus:<br />
Ziel-Adresse: http://testserver.lan/upload/Artikel/upload.php</div>
<div class="note-box-text note-box-example-code">POST /upload/Artikel/upload.php HTTP/1.1
Host: testserver.lan
... <i>(gekürzt)</i>
Content-Type: multipart/form-data; boundary=---------------------------3902153292
Content-Length: 464
-----------------------------3902153292
Content-Disposition: form-data; name=&quot;dateiupload&quot;; filename=&quot;upload.php&quot;
Content-Type: application/octet-stream

&lt;?php  #### upload.php ####

if ($_FILES)
{
    echo &quot;&lt;pre&gt;\r\n&quot;;
    echo htmlspecialchars(print_r($_FILES,1));
    echo &quot;&lt;/pre&gt;\r\n&quot;;
}

?&gt;
-----------------------------3902153292
Content-Disposition: form-data; name=&quot;btn[upload]&quot;

Daten absenden
-----------------------------3902153292--
</div>
<div class="note-box-text note-box-example-comment">Wie man aus dem Mitschnitt der HTTP-Header sehen kann, findet der HTTP-Upload im Klartext statt. Dateien werden vom Browser als simpler Bytestream eingebunden. Der Server hat hier nur über die Boundary die Möglichkeit, das Ende der übertragenen Datei (hier das für die Kontrolle benutzte PHP-Script) zu erkennen.</div>
<div class="note-box-text note-box-example-comment">Das antwortet der Server (Response-Headers):</div>
<div class="note-box-text note-box-example-code">HTTP/1.1 200 OK
Date: Thu, 08 Apr 2010 08:03:34 GMT
<i>... (gekürzt)</i>
Content-Length: 282
Content-Type: text/html; charset=ISO-8859-1

... <i>(HTML-Dokument)</i></div>
</div>
<h4><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=4" title="Abschnitt bearbeiten: Server">Bearbeiten</a>]</span> <span class="mw-headline" id="Server">Server</span></h4>
<p>Der Webserver muss auf einen Upload eingestellt sein. Bei Verwendung von PHP findet dies bei der Installation automatisch statt. Die Methode POST wird von PHP von Haus aus unterstützt.
</p><p>Außerdem muss in der php.ini der Eintrag <code>file_uploads=on</code> vorhanden sein.
</p><p>Das superglobale Array <code>$_FILES</code> wird trotzdem immer angelegt, wenn der Browser für den Request ein <code>&lt;input type="file" ... &gt;</code> verarbeitet hat, also im Requestbody "multipart/form-data" und "filename=DATEINAME" vorhanden sind. Dabei ist es unerheblich, ob wirklich ein File übertragen wurde. Dies erkennen wir im Folgenen aus den Fehlercodes.
</p>
<h4><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=5" title="Abschnitt bearbeiten: Verzeichnisstruktur">Bearbeiten</a>]</span> <span class="mw-headline" id="Verzeichnisstruktur">Verzeichnisstruktur</span></h4>
<p>Um Upload-Daten auf dem Server speichern zu können, muss ein <code>upload_tmp_dir</code> vorhanden sein. Bei Standardeinrichtungen liegt dies meist im shared Temporary Directory. <b>Die Standard-Einrichtung ist für Shared Hosts nicht zu empfehlen</b>, da auch andere VirtHosts Zugriff auf das gemeinsame Verzeichnis <code>/tmp/</code> nehmen können. Diese können zwar den Dateinamen nicht ändern und die Datei nicht löschen, aber sie können den Inhalt verändern.
</p><p>Eine empfohlene Verzeichnisstruktur sieht daher wie folgt aus:
</p>
<div class="note-box note-box-example vorlage_beispiel">
<div class="note-box-title">Beispiel
</div>
<div class="note-box-text note-box-example-code"><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="apache source-apache"><pre class="de1">/var/www/virthosts/example.org/htdocs
/var/www/virthosts/example.org/data
/var/www/virthosts/example.org/sessions
/var/www/virthosts/example.org/<span class="kw2">includes</span>
/var/www/virthosts/example.org/tmp
/var/www/virthosts/example.org/logs</pre></div></div></div>
</div>
<p>Dies muss dann bei der Virtual-Host-Einrichtung auch bei den Einstellungen für <code>open_basedir</code> berücksichtigt werden
</p>
<div class="note-box note-box-example vorlage_beispiel">
<div class="note-box-title">Beispiel
</div>
<div class="note-box-text note-box-example-code"><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="apache source-apache"><pre class="de1"><span class="kw1">DocumentRoot</span> /var/www/virthosts/example.org/htdocs
&#160;
<span class="kw1">php_admin_value</span> open_basedir /var/www/virthosts/example.org/
<span class="kw1">php_admin_value</span> upload_tmp_dir /var/www/virthosts/example.org/tmp/
<span class="kw1">php_admin_value</span> session.save_path /var/www/virthosts/example.org/sessions/
&#160;
<span class="co1"># ...</span></pre></div></div></div>
</div>
<h4><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=6" title="Abschnitt bearbeiten: POST auswerten">Bearbeiten</a>]</span> <span class="mw-headline" id="POST_auswerten">POST auswerten</span></h4>
<p>Die Clients übergeben Files nur mit der POST-Methode.
</p><p>Das PHP-System (seit 4.x) übergibt alle notwendigen Daten in den „superglobalen Arrays“ <code>$_POST</code>, <code>$_GET</code>, <code>$_FILES</code> usw. an das assozierte Script.
</p><p>Wir wollen für die Upload-relevanten Daten bitte nur noch diese Arrays, speziell das Array <code>$_FILES</code> benutzen. Alle anderen zur Übergabe bisher verwendeten Parameter und Parameter-Arrays können unsicher sein! Die anderen Datenstrukturen könnten vom Client auch nachhaltig manipuliert sein.
</p><p>Bei einem Dateiupload benötigen wir dann bei PHP nur sehr wenige Zeilen, um an die notwendigen Informationen für die Weiterverarbeitung zu kommen. Dies verleitet leider immer noch allzu leicht dazu, sich dieser Weiterverarbeitung nicht wenigstens ausreichend zu widmen und so entstehen viele ungenügende Scripte, die große Sicherheitslücken in die Webserver reißen. Anschließend stehen die betroffenen Server dann für Missbrauch zur Verfügung.
</p><p>Um uns erst einmal einen Überblick über die ankommenden Daten zu machen, benötigen wir nur ein kleines Testscript:
</p>
<div class="note-box note-box-example vorlage_beispiel">
<div class="note-box-title">Beispiel
</div>
<div class="note-box-text note-box-example-code"><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="php source-php"><pre class="de1"><span class="kw2">&lt;?php</span>  <span class="co2">#### upload.php ####
</span>
<span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">empty</span><span class="br0">&#40;</span><span class="re0">$_FILES</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="kw1">echo</span> <span class="st0">&quot;&lt;pre&gt;<span class="es1">\r</span><span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
    <span class="kw1">echo</span> <span class="kw3">htmlspecialchars</span><span class="br0">&#40;</span><span class="kw3">print_r</span><span class="br0">&#40;</span><span class="re0">$_FILES</span><span class="sy0">,</span><span class="nu0">1</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw1">echo</span> <span class="st0">&quot;&lt;/pre&gt;<span class="es1">\r</span><span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
<span class="br0">&#125;</span>
&#160;
<span class="sy1">?&gt;</span></pre></div></div></div>
</div>
<p>Hinweis: 
Warum <code>"!empty($_FILES)"</code>?
Wenn der Client kein "multipart/form-data" und im entsprechenden Abschnitt kein <code>filename="FILENAME"</code> überträgt, wird das Array <code>$_FILES</code> nicht angelegt.
</p><p><br />
Benutzt man dieses Testscript durch den vorhin bereits gezeigten Request des Browsers, antwortet der Server mit der nachfolgenden Response (zusätzlich zu den oben schon beschriebenen Headers):
</p>
<pre>

Array
(
    [dateiupload] =&gt; Array
        (
            [name] =&gt; upload.php
            [type] =&gt; application/octet-stream
            [tmp_name] =&gt; C:\Programme\xampp\tmp\php4D8.tmp
            [error] =&gt; 0
            [size] =&gt; 150
        )

)

</pre>
<p><br />
Abgebildet wird hier durch das kleine Script das superglobale Array <code>$_FILES</code>. Dieses enthält ein Element <code>[dateiupload]</code>. Der Name des Elementes rührt vom <code>Name</code>-Attribut des <code>&lt;input&gt;</code>-Elementes vom Typ <code>File</code> aus dem HTML-Dokument, das wir für den Client gebaut hatten.
</p><p>Das Element <code>[dateiupload]</code> enthält nun wieder Unterelemente und ihre Werte, die von PHP angelegt wurden:
</p>
<ul><li> <code>[name]</code> enthält den Namen der Datei, den der Client mitgesendet hat, kann aber auch einen ganzen Pfad enthalten, ist daher unsicher
</li><li> <code>[type]</code> enthält den MIME-Type der Datei, den der Client behauptet, ist daher unsicher
</li><li> <code>[tmp_name]</code> enthält den Pfad zur temporären Datei auf dem Webserver, wird vom Webserver vergeben, ist nicht von außen überschreibbar und daher sicher
</li><li> <code>[error]</code> enthält Errorcodes laut <a rel="nofollow" class="external text" href="http://de2.php.net/manual/en/features.file-upload.errors.php">Spezifikation</a>, wird vom Webserver ermittelt und ist daher sicher
</li><li> <code>[size]</code> enthält die Größe der Temporärdatei in Bytes, wird vom Webserver ermittelt und ist daher sicher
</li></ul>
<p>Als „sicher“ werden hier nur die zur Verfügung stehenden Werte betrachtet, nicht jedoch der Inhalt des Upload-Files.
</p><p>Zur Weiterverarbeitung der hochgeladenen Daten bauen wir uns eine Funktion (oder bei OOP eine Methode), die alle zu berücksichtigen Prüfungen vornehmen wird, die hochgeladene Datei an ihren Speicherort verschiebt und uns am Ende mit einem <code>true</code> oder <code>false</code> über den Erfolg informiert.
</p>
<h4><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=7" title="Abschnitt bearbeiten: Error-Codes des Uploads">Bearbeiten</a>]</span> <span class="mw-headline" id="Error-Codes_des_Uploads">Error-Codes des Uploads</span></h4>
<p>siehe <a rel="nofollow" class="external free" href="http://www.php.net/manual/en/features.file-upload.errors.php">http://www.php.net/manual/en/features.file-upload.errors.php</a>
</p>
<pre>

UPLOAD_ERR_OK         Value: 0; There is no error, the file uploaded with success.

UPLOAD_ERR_INI_SIZE   Value: 1; The uploaded file exceeds the upload_max_filesize directive in php.ini.

UPLOAD_ERR_FORM_SIZE  Value: 2; The uploaded file exceeds the MAX_FILE_SIZE directive that 
                                was specified in the HTML form.

UPLOAD_ERR_PARTIAL    Value: 3; The uploaded file was only partially uploaded.

UPLOAD_ERR_NO_FILE    Value: 4; No file was uploaded.

UPLOAD_ERR_NO_TMP_DIR Value: 6; Missing a temporary folder. Introduced in PHP 4.3.10 and PHP 5.0.3.

UPLOAD_ERR_CANT_WRITE Value: 7; Failed to write file to disk. Introduced in PHP 5.1.0.

UPLOAD_ERR_EXTENSION  Value: 8; A PHP extension stopped the file upload. PHP does not provide a way 
                                to ascertain which extension caused the file upload to stop; examining 
                                the list of loaded extensions with phpinfo() may help. 
                                Introduced in PHP 5.2.0.

</pre>
<p><br />
</p>
<h4><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=8" title="Abschnitt bearbeiten: Der Parameter MAX FILE SIZE">Bearbeiten</a>]</span> <span class="mw-headline" id="Der_Parameter_MAX_FILE_SIZE">Der Parameter MAX_FILE_SIZE</span></h4>
<p>PHP bietet die (unsichere) Möglichkeit, jedem hochzuladenden File eine eigene Größenbegrenzung zuzuordnen.
</p><p><code>&lt;input type="hidden" name="MAX_FILE_SIZE" value="4096"&gt;</code>
</p><p>Diese Angabe muss dann <u>vor</u> dem jeweiligen &lt;input type="file" ...&gt;-Element stehen und gilt solange für alle darauffolgenden Upload-Elemente, bis sie durch eine neue Angabe überschrieben wird.
</p><p>PHP bricht bei Erreichen der angegeben Grenze in Bytes die Übernahme des Files ab und verwirft es. Als Error-Code erscheint dann <code>UPLOAD_ERR_FORM_SIZE</code> ( === 2 ) im dazugehörigen Error-Element des $_FILES-Arrays.
</p><p>Da die Angabe aber vom Client kommt, ist sie unsicher. Im Zweifel gilt daher für jedes File die Direktive <code>upload_max_filesize</code> aus der php.ini, der VirtHost-Konfiguration oder einer .htaccess-Direktive.
Siehe auch <a rel="nofollow" class="external free" href="http://de2.php.net/manual/en/ini.core.php#ini.upload-max-filesize">http://de2.php.net/manual/en/ini.core.php#ini.upload-max-filesize</a>
</p><p>Für alle Files zusammen inclusive sonstigen Post-Parametern gilt die Grenze <code>post_max_size</code>
Siehe auch <a rel="nofollow" class="external free" href="http://de2.php.net/manual/en/ini.core.php#ini.post-max-size">http://de2.php.net/manual/en/ini.core.php#ini.post-max-size</a>
</p>
<h3><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=9" title="Abschnitt bearbeiten: Post mit mehreren Dateien">Bearbeiten</a>]</span> <span class="mw-headline" id="Post_mit_mehreren_Dateien">Post mit mehreren Dateien</span></h3>
<p>Für den Post mit mehreren Dateien stellt uns PHP mehrere Möglichkeiten zur Verfügung, von denen wir zwei zeigen wollen:
</p>
<div class="note-box note-box-example vorlage_beispiel">
<div class="note-box-title">Beispiel
</div>
<p>Array-Variante:
</p>
<div class="note-box-text note-box-example-code"><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="php source-php"><pre class="de1">    &lt;form id=&quot;upload&quot; action=&quot;<span class="kw2">&lt;?php</span> <span class="kw1">echo</span> <span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st_h">'SCRIPT_NAME'</span><span class="br0">&#93;</span><span class="sy0">;</span> <span class="sy1">?&gt;</span>&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;
        onSubmit=&quot;document.getElementById('btn_send').setAttribute('disabled','disabled');&quot;&gt;
&#160;
        &lt;input id=&quot;file_01&quot; type=&quot;file&quot; name=&quot;file[1]&quot; size=&quot;50&quot;&gt;
	&lt;input id=&quot;file_02&quot; type=&quot;file&quot; name=&quot;file[2]&quot; size=&quot;50&quot;&gt;
	&lt;input id=&quot;file_03&quot; type=&quot;file&quot; name=&quot;file[3]&quot; size=&quot;50&quot;&gt;
	&lt;input id=&quot;file_04&quot; type=&quot;file&quot; name=&quot;file[4]&quot; size=&quot;50&quot;&gt;
&#160;
	&lt;input id=&quot;btn_send&quot; type=&quot;submit&quot; name=&quot;btn[send]&quot; value=&quot;senden&quot;&gt;	
&#160;
    &lt;/form&gt;</pre></div></div></div>
</div>
<p>Man kann die Name-Attribute auch als <code>file[]</code> notieren. PHP numeriert die Array-Elemente auf dem Server dann selbsttätig durch, beginnend bei 0.
</p><p><br />
</p><p><br />
</p>
<div class="note-box note-box-example vorlage_beispiel">
<div class="note-box-title">Beispiel
</div>
<p>Diskrete Namen:
</p>
<div class="note-box-text note-box-example-code"><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="php source-php"><pre class="de1">    &lt;form id=&quot;upload&quot; action=&quot;<span class="kw2">&lt;?php</span> <span class="kw1">echo</span> <span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st_h">'SCRIPT_NAME'</span><span class="br0">&#93;</span><span class="sy0">;</span> <span class="sy1">?&gt;</span>&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;
        onSubmit=&quot;document.getElementById('btn_send').setAttribute('disabled','disabled');&quot;&gt;
&#160;
        &lt;input id=&quot;file_01&quot; type=&quot;file&quot; name=&quot;file_01&quot; size=&quot;50&quot;&gt;
	&lt;input id=&quot;file_02&quot; type=&quot;file&quot; name=&quot;file_02&quot; size=&quot;50&quot;&gt;
	&lt;input id=&quot;file_03&quot; type=&quot;file&quot; name=&quot;file_03&quot; size=&quot;50&quot;&gt;
	&lt;input id=&quot;file_04&quot; type=&quot;file&quot; name=&quot;file_04&quot; size=&quot;50&quot;&gt;
&#160;
	&lt;input id=&quot;btn_send&quot; type=&quot;submit&quot; name=&quot;btn[send]&quot; value=&quot;senden&quot;&gt;	
&#160;
    &lt;/form&gt;</pre></div></div></div>
</div>
<p><br />
Der Unterschied zeigt sich dann mittels unseres Testscriptes auf dem Server:
</p>
<div class="note-box note-box-example vorlage_beispiel">
<div class="note-box-title">Beispiel
</div>
<p>Array-Variante:
</p>
<div class="note-box-text note-box-example-code"><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="php source-php"><pre class="de1"><span class="kw3">Array</span>
<span class="br0">&#40;</span>
    <span class="br0">&#91;</span><span class="kw3">file</span><span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="kw3">Array</span>
        <span class="br0">&#40;</span>
            <span class="br0">&#91;</span>name<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="kw3">Array</span>
                <span class="br0">&#40;</span>
                    <span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="sy0">=&gt;</span> 35mm<span class="sy0">-</span>filmstreifen<span class="sy0">.</span>jpg
                    <span class="br0">&#91;</span><span class="nu0">2</span><span class="br0">&#93;</span> <span class="sy0">=&gt;</span> Blockhaus_innen_Saal<span class="sy0">.</span>jpg
                    <span class="br0">&#91;</span><span class="nu0">3</span><span class="br0">&#93;</span> <span class="sy0">=&gt;</span> lupe<span class="sy0">.</span>gif
                    <span class="br0">&#91;</span><span class="nu0">4</span><span class="br0">&#93;</span> <span class="sy0">=&gt;</span> Satelliten<span class="sy0">-</span>Foto <span class="br0">&#40;</span>Google<span class="sy0">-</span>Maps<span class="br0">&#41;</span><span class="sy0">.</span>bmp
                <span class="br0">&#41;</span>
&#160;
            <span class="br0">&#91;</span>type<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="kw3">Array</span>
                <span class="br0">&#40;</span>
                    <span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="sy0">=&gt;</span> image<span class="sy0">/</span>jpeg
                    <span class="br0">&#91;</span><span class="nu0">2</span><span class="br0">&#93;</span> <span class="sy0">=&gt;</span> image<span class="sy0">/</span>jpeg
                    <span class="br0">&#91;</span><span class="nu0">3</span><span class="br0">&#93;</span> <span class="sy0">=&gt;</span> image<span class="sy0">/</span>gif
                    <span class="br0">&#91;</span><span class="nu0">4</span><span class="br0">&#93;</span> <span class="sy0">=&gt;</span> 
                <span class="br0">&#41;</span>
&#160;
            <span class="br0">&#91;</span>tmp_name<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="kw3">Array</span>
                <span class="br0">&#40;</span>
                    <span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="sy0">=&gt;</span> M<span class="sy0">:</span>\User\Tom\www\testserver<span class="sy0">.</span>lan\tmp\php12F<span class="sy0">.</span>tmp
                    <span class="br0">&#91;</span><span class="nu0">2</span><span class="br0">&#93;</span> <span class="sy0">=&gt;</span> M<span class="sy0">:</span>\User\Tom\www\testserver<span class="sy0">.</span>lan\tmp\php130<span class="sy0">.</span>tmp
                    <span class="br0">&#91;</span><span class="nu0">3</span><span class="br0">&#93;</span> <span class="sy0">=&gt;</span> M<span class="sy0">:</span>\User\Tom\www\testserver<span class="sy0">.</span>lan\tmp\php131<span class="sy0">.</span>tmp
                    <span class="br0">&#91;</span><span class="nu0">4</span><span class="br0">&#93;</span> <span class="sy0">=&gt;</span> 
                <span class="br0">&#41;</span>
&#160;
            <span class="br0">&#91;</span>error<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="kw3">Array</span>
                <span class="br0">&#40;</span>
                    <span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="nu0">0</span>
                    <span class="br0">&#91;</span><span class="nu0">2</span><span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="nu0">0</span>
                    <span class="br0">&#91;</span><span class="nu0">3</span><span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="nu0">0</span>
                    <span class="br0">&#91;</span><span class="nu0">4</span><span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="nu0">1</span>
                <span class="br0">&#41;</span>
&#160;
            <span class="br0">&#91;</span>size<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="kw3">Array</span>
                <span class="br0">&#40;</span>
                    <span class="br0">&#91;</span><span class="nu0">1</span><span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="nu0">12645</span>
                    <span class="br0">&#91;</span><span class="nu0">2</span><span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="nu0">112716</span>
                    <span class="br0">&#91;</span><span class="nu0">3</span><span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="nu0">1373</span>
                    <span class="br0">&#91;</span><span class="nu0">4</span><span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="nu0">0</span>
                <span class="br0">&#41;</span>
&#160;
        <span class="br0">&#41;</span>
&#160;
<span class="br0">&#41;</span></pre></div></div></div>
</div>
<p>Auf den Fehler beim File Nr. 4 kommen wir gleich zurück.
</p><p><br />
</p>
<div class="note-box note-box-example vorlage_beispiel">
<div class="note-box-title">Beispiel
</div>
<p>Diskrete Namen:
</p>
<div class="note-box-text note-box-example-code"><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="php source-php"><pre class="de1"><span class="kw3">Array</span>
<span class="br0">&#40;</span>
    <span class="br0">&#91;</span>file_01<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="kw3">Array</span>
        <span class="br0">&#40;</span>
            <span class="br0">&#91;</span>name<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> Blockhaus_Plan_EG<span class="sy0">.</span>jpg
            <span class="br0">&#91;</span>type<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> image<span class="sy0">/</span>jpeg
            <span class="br0">&#91;</span>tmp_name<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> M<span class="sy0">:</span>\User\Tom\www\testserver<span class="sy0">.</span>lan\tmp\php13C<span class="sy0">.</span>tmp
            <span class="br0">&#91;</span>error<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="nu0">0</span>
            <span class="br0">&#91;</span>size<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="nu0">38118</span>
        <span class="br0">&#41;</span>
&#160;
    <span class="br0">&#91;</span>file_02<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="kw3">Array</span>
        <span class="br0">&#40;</span>
            <span class="br0">&#91;</span>name<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> 35mm<span class="sy0">-</span>filmstreifen_br<span class="sy0">.</span>jpg
            <span class="br0">&#91;</span>type<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> image<span class="sy0">/</span>jpeg
            <span class="br0">&#91;</span>tmp_name<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> M<span class="sy0">:</span>\User\Tom\www\testserver<span class="sy0">.</span>lan\tmp\php13D<span class="sy0">.</span>tmp
            <span class="br0">&#91;</span>error<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="nu0">0</span>
            <span class="br0">&#91;</span>size<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="nu0">9901</span>
        <span class="br0">&#41;</span>
&#160;
    <span class="br0">&#91;</span>file_03<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="kw3">Array</span>
        <span class="br0">&#40;</span>
            <span class="br0">&#91;</span>name<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> lupe<span class="sy0">.</span>gif
            <span class="br0">&#91;</span>type<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> image<span class="sy0">/</span>gif
            <span class="br0">&#91;</span>tmp_name<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> M<span class="sy0">:</span>\User\Tom\www\testserver<span class="sy0">.</span>lan\tmp\php13E<span class="sy0">.</span>tmp
            <span class="br0">&#91;</span>error<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="nu0">0</span>
            <span class="br0">&#91;</span>size<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="nu0">1373</span>
        <span class="br0">&#41;</span>
&#160;
    <span class="br0">&#91;</span>file_04<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="kw3">Array</span>
        <span class="br0">&#40;</span>
            <span class="br0">&#91;</span>name<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> Rad_01<span class="sy0">.</span>jpg
            <span class="br0">&#91;</span>type<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> image<span class="sy0">/</span>jpeg
            <span class="br0">&#91;</span>tmp_name<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> M<span class="sy0">:</span>\User\Tom\www\testserver<span class="sy0">.</span>lan\tmp\php13F<span class="sy0">.</span>tmp
            <span class="br0">&#91;</span>error<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="nu0">0</span>
            <span class="br0">&#91;</span>size<span class="br0">&#93;</span> <span class="sy0">=&gt;</span> <span class="nu0">3927</span>
        <span class="br0">&#41;</span>
&#160;
<span class="br0">&#41;</span></pre></div></div></div>
</div>
<p><br />
PHP baut das $_FILES-Array unterschiedlich auf, je nachdem, ob der Client Array-Bezeichner oder Skalare als Bezeichner benutzt. Wenn man das Ganze mischt, wird es noch verrückter!
</p><p><br />
Als erstes sollte der Errorcode im Element <code>$_FILES['dateiupload']['error']</code> überprüft werden
</p>
<div class="note-box note-box-example vorlage_beispiel">
<div class="note-box-title">Beispiel
</div>
<div class="note-box-text note-box-example-code"><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="php source-php"><pre class="de1">    <span class="co2">### Skalare Namensangabe: ###
</span>    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$_FILES</span><span class="br0">&#91;</span><span class="re0">$fileupload</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'error'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span> 
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$_FILES</span><span class="br0">&#91;</span><span class="re0">$fileupload</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'error'</span><span class="br0">&#93;</span> <span class="sy0">===</span> UPLOAD_ERR_OK<span class="br0">&#41;</span>
        <span class="br0">&#123;</span>
            file_process<span class="br0">&#40;</span><span class="re0">$_FILES</span><span class="br0">&#91;</span><span class="re0">$fileupload</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>   <span class="co2">### Verarbeitungsfunktion erstellen wir im Folgenden
</span>        <span class="br0">&#125;</span>
        <span class="co2">### Namensangabe als Array ### 
</span>        <span class="kw1">elseif</span> <span class="br0">&#40;</span><span class="kw3">is_array</span><span class="br0">&#40;</span><span class="re0">$_FILES</span><span class="br0">&#91;</span><span class="re0">$fileupload</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'error'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
        <span class="br0">&#123;</span>
            <span class="kw1">foreach</span><span class="br0">&#40;</span><span class="re0">$_FILES</span><span class="br0">&#91;</span><span class="re0">$fileupload</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'error'</span><span class="br0">&#93;</span> <span class="kw1">as</span> <span class="re0">$key</span> <span class="sy0">=&gt;</span> <span class="re0">$error</span><span class="br0">&#41;</span>
            <span class="br0">&#123;</span>
                <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$error</span> <span class="sy0">===</span> UPLOAD_ERR_OK<span class="br0">&#41;</span>
                <span class="br0">&#123;</span>
                    <span class="re0">$_filerec</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
                    <span class="re0">$_filerec</span><span class="br0">&#91;</span><span class="st_h">'name'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="re0">$_FILES</span><span class="br0">&#91;</span><span class="re0">$fileupload</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'name'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="re0">$key</span><span class="br0">&#93;</span><span class="sy0">;</span>
                    <span class="re0">$_filerec</span><span class="br0">&#91;</span><span class="st_h">'type'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="re0">$_FILES</span><span class="br0">&#91;</span><span class="re0">$fileupload</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'type'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="re0">$key</span><span class="br0">&#93;</span><span class="sy0">;</span>
                    <span class="re0">$_filerec</span><span class="br0">&#91;</span><span class="st_h">'tmp_name'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="re0">$_FILES</span><span class="br0">&#91;</span><span class="re0">$fileupload</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'tmp_name'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="re0">$key</span><span class="br0">&#93;</span><span class="sy0">;</span>
                    <span class="re0">$_filerec</span><span class="br0">&#91;</span><span class="st_h">'error'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="re0">$_FILES</span><span class="br0">&#91;</span><span class="re0">$fileupload</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'error'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="re0">$key</span><span class="br0">&#93;</span><span class="sy0">;</span>
                    <span class="re0">$_filerec</span><span class="br0">&#91;</span><span class="st_h">'size'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="re0">$_FILES</span><span class="br0">&#91;</span><span class="re0">$fileupload</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'size'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="re0">$key</span><span class="br0">&#93;</span><span class="sy0">;</span>
&#160;
                    file_process<span class="br0">&#40;</span><span class="re0">$_filerec</span><span class="br0">&#41;</span><span class="sy0">;</span>
                <span class="br0">&#125;</span>
            <span class="br0">&#125;</span> 
        <span class="br0">&#125;</span>
        <span class="kw1">else</span>
        <span class="br0">&#123;</span>
            <span class="co2">### Fehlerbearbeitung, oder
</span>            <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
    <span class="br0">&#125;</span></pre></div></div></div>
</div>
<p>Wenn die Abfrage des <code>[error]</code>-Elementes genau (Identitätsvergleich) dem Wert <a rel="nofollow" class="external text" href="http://de2.php.net/manual/en/features.file-upload.errors.php">UPLOAD_ERR_OK</a> entspricht, dann sagt uns PHP damit, dass unter dem Elementnamen [dateiupload] des $_FILES-Arrays genau eine Datei mit dem letzten (dem Script zugeordneten) Post-Request fehlerfrei auf den Server hochgeladen wurde (der Upload mehrerer Dateien wird später betrachtet). Der Server hat diese Datei im Temporärverzeichnis abgelegt und dort ist sie nun für das Script unter dem im Element <code>[tmp_name]</code> abgelegten vollständigen Pfad erreichbar. 
</p><p>Solange sich die Datei im Temporärverzeichnis befindet, könnte sie dort von anderen Anwendungen, z.B. PHP-Instanzen anderer User, manipuliert werden. Auf Linux-Systemen kann sie zwar in der Regel nicht umbenannt oder gelöscht werden (gesetztes t-Flag), aber ihr Inhalt ist nicht sicher. Um dies zu vermeiden, sollte in einer Shared-Hosting-Umgebung die Einstellung für <i>upload_tmp_dir</i> unbedingt für jede Anwendung / jedes Projekt auf ein eigenes Verzeichnis zeigen, das für andere PHP-Prozesse nicht erreichbar ist.  Das Temporärverzeichnis sollte unbedingt auch außerhalb der Document Root liegen! Dies muss dann auch durch eine passende Einstellung von <i>open_base_dir</i> berücksichtigt werden, damit das Verzeichnis für das Script erreichbar ist.
</p><p>Wir könnten die Datei nun einfach aus dem Temporärverzeichnis an eine andere Stelle innerhalb unseres für PHP zugänglichen Dateibaumes kopieren. 
</p><p><b>Aber genau das wollen wir nicht ungeprüft tun</b>!
</p><p><br />
</p>
<div class="note-box note-box-todo"><p class="note-box-title">ToDo:&#160;&#160;&#160;&#160;<span class="note-box-more small">(<a href="http://wiki.selfhtml.org/wiki/Kategorie:ToDo" title="Kategorie:ToDo"><span style="color:#eef;text-decoration:underline">weitere ToDos</span></a>)</span></p><div class="note-box-text">
<p>[Funktionsrumpf Multi-Upload auswerten]
</p>
</div></div>
<h2><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=10" title="Abschnitt bearbeiten: Sicherheit">Bearbeiten</a>]</span> <span class="mw-headline" id="Sicherheit">Sicherheit</span></h2>
<p>Wer es zulässt, dass auf seinen Server Daten oder Dateien hochgeladen werden, riskiert immer die Sicherheit seines Systems. Es ist daher unbedingt notwendig, sich genaue Gedanken über den Verbleib der Daten auf dem Server und den Umgang damit zu machen.
</p><p>Eine grundsätzliche Frage muss daher immer geklärt werden:
</p><p><b>Können hochgeladene Daten oder auch nur Teile davon zu irgendeinem Zeitpunkt die Programmkontrolle erlangen?</b>
</p><p><br />
</p>
<h3><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=11" title="Abschnitt bearbeiten: Sauberen Upload erkennen">Bearbeiten</a>]</span> <span class="mw-headline" id="Sauberen_Upload_erkennen">Sauberen Upload erkennen</span></h3>
<p>Unter "sauberer Upload" verstehen wir hier, dass eine Datei technisch ordnungsgemäß auf unser Zielsystem übertragen werden konnte. Dies beinhaltet die Konsistenz der Daten und die Zuordnungsfähigkeit zu einem Thread (Request). Dies beinhaltet erst einmal <b>nicht die Gefahrlosigkeit</b> der Datei. Diese müssen wir im weiteren diskret untersuchen.
</p>
<h3><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=12" title="Abschnitt bearbeiten: MIME-Type erkennen">Bearbeiten</a>]</span> <span class="mw-headline" id="MIME-Type_erkennen">MIME-Type erkennen</span></h3>
<p>Der MIME-Type einer Datei kennzeichnet in etwa ihre Intention, also für welchen Zweck sie vorgesehen ist. So sollten neben der Weiterverarbeitung z.B. Bilder zur Anzeige in einem Grafikprogramm (oder dem integrierten Grafiktool des Browsers), MS-Word-Dateien zur Anzeige mit MS-Word, PDF-Dateien zur Ansicht in einem PDF-Reader, usw. bereitgestellt werden. Bilder sollten aber <b>nicht</b> zur Ausführung als PHP-Datei auf dem Server führen! Genau dies ist aber bei schlampiger Behandlung möglich.
</p><p>Für die Erkennung des "Multipurpose Internet Mail Extensions"-Formats (MIME-Type) einer Datei ist eine serverseitige Erkennung notwendig. Die vom Client gemeldeten MIME-Types in <code>$_FILES['inputname']['type']</code> sind für die Absicherung <b>nicht</b> geeignet, da diese Angabe beliebig gefälscht sein kann.
</p><p>Eine MIME-Type-Erkennung auf dem Server ist aber auch kein Allheilmittel, da z.B. eine eindeutig als JPEG-Datei erkannte Datei durchaus in ihrem EXIF-Header immer noch ein vollwertiges (PHP-)Script enthalten kann.
</p><p>PHP hat für die MIME-Type-Bestimmung die Funktion <code>mime_content_type()</code> (<a rel="nofollow" class="external text" href="http://de3.php.net/manual/de/function.mime-content-type.php">Handbuch</a>) angeboten, die aber seit längerem schon auf der Unerwünscht-Liste steht. Leider enthält die alternativ dafür aufgenommene <code>PECL extension <b>Fileinfo</b></code> diverse Unzulänglichkeiten und zusätzliche Unsicherheiten, wie man durch einfache Suchmaschinen-Recherche feststellen wird. Dies mag ein Grund dafür sein, dass die Funktion <code>mime_content_type()</code> immer noch existiert.
</p><p>Seitdem die <b>Fileinfo</b>-Funktionen Modul des normalen PHP-Sprachumfangs sind (ab PHP 5.3.0), sind auch diese ohne größere Bedenken nutzbar. Sie sind allerdings etwas aufwändiger, als die Funktion <code>mime_content_type()</code>
</p><p>Wenn man leider über keine der Funktionen verfügt, kann man sich die Funktion <code>mime_content_type()</code> ggf. auch selber bauen:
</p>
<div class="note-box note-box-example vorlage_beispiel">
<div class="note-box-title">Beispiel
</div>
<div class="note-box-text note-box-example-code"><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="php source-php"><pre class="de1"><span class="kw2">&lt;?php</span>   <span class="co2">#### mime_content_type.php ####
</span>
<span class="kw1">if</span><span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">function_exists</span><span class="br0">&#40;</span><span class="st_h">'mime_content_type'</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="kw2">function</span> <span class="kw3">mime_content_type</span><span class="br0">&#40;</span><span class="re0">$filename</span><span class="sy0">,</span> <span class="sy0">&amp;</span><span class="re0">$errortxt</span><span class="sy0">=</span><span class="st_h">''</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="co2">#########################################################
</span>        <span class="co2">## Please do not use any direct user input for $filename
</span>        <span class="co2">#########################################################
</span>        
        <span class="co2">## for use on windows systems please install first:
</span>        <span class="co2">## http://gnuwin32.sourceforge.net/packages/file.htm
</span>        <span class="re0">$path</span> <span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st_h">'WINDIR'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
        <span class="br0">&#123;</span>
            <span class="re0">$path</span> <span class="sy0">=</span> <span class="st0">&quot;C:/Programme/GnuWin32/bin/&quot;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>    
&#160;
        <span class="re0">$filepath</span> <span class="sy0">=</span> <span class="kw3">realpath</span><span class="br0">&#40;</span><span class="re0">$filename</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="re0">$_mime</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
        <span class="co2">## escape spaces in $filename due to their separating effect 
</span>        <span class="re0">$filepath</span> <span class="sy0">=</span> <span class="kw3">str_replace</span><span class="br0">&#40;</span><span class="st0">&quot; &quot;</span><span class="sy0">,</span><span class="st0">&quot;<span class="es1">\\</span> &quot;</span><span class="sy0">,</span><span class="re0">$filepath</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
        <span class="kw3">exec</span> <span class="br0">&#40;</span><span class="re0">$path</span> <span class="sy0">.</span> <span class="st0">&quot;file -bi <span class="es4">$filepath</span>&quot;</span><span class="sy0">,</span> <span class="re0">$_mime</span><span class="sy0">,</span> <span class="re0">$error</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="br0">&#40;</span><span class="re0">$error</span><span class="br0">&#41;</span> or <span class="br0">&#40;</span><span class="kw3">count</span><span class="br0">&#40;</span><span class="re0">$_mime</span><span class="br0">&#41;</span> <span class="sy0">!=</span> <span class="nu0">1</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span>
&#160;
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">strpos</span><span class="br0">&#40;</span><span class="re0">$_mime</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="st0">&quot;can't stat&quot;</span><span class="br0">&#41;</span> <span class="sy0">!==</span> <span class="kw4">false</span><span class="br0">&#41;</span>
        <span class="br0">&#123;</span>
            <span class="re0">$errortxt</span> <span class="sy0">=</span> <span class="st0">&quot;unknown type&quot;</span><span class="sy0">;</span>
            <span class="re0">$mime</span> <span class="sy0">=</span> <span class="kw4">false</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
        <span class="kw1">elseif</span> <span class="br0">&#40;</span><span class="kw3">strpos</span><span class="br0">&#40;</span><span class="re0">$_mime</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="st0">&quot;can't read&quot;</span><span class="br0">&#41;</span> <span class="sy0">!==</span> <span class="kw4">false</span><span class="br0">&#41;</span>
        <span class="br0">&#123;</span>
            <span class="re0">$errortxt</span> <span class="sy0">=</span> <span class="st0">&quot;cannot read file&quot;</span><span class="sy0">;</span>
            <span class="re0">$mime</span> <span class="sy0">=</span> <span class="kw4">false</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
        <span class="kw1">elseif</span> <span class="br0">&#40;</span><span class="kw3">strpos</span><span class="br0">&#40;</span><span class="re0">$_mime</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="st0">&quot;can't &quot;</span><span class="br0">&#41;</span> <span class="sy0">!==</span> <span class="kw4">false</span><span class="br0">&#41;</span>
        <span class="br0">&#123;</span>
            <span class="re0">$errortxt</span> <span class="sy0">=</span> <span class="st0">&quot;unspecified error&quot;</span><span class="sy0">;</span>
            <span class="re0">$mime</span> <span class="sy0">=</span> <span class="kw4">false</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
        <span class="kw1">else</span>
        <span class="br0">&#123;</span>
            <span class="re0">$mime</span> <span class="sy0">=</span> <span class="kw3">trim</span><span class="br0">&#40;</span><span class="re0">$_mime</span><span class="br0">&#91;</span><span class="nu0">0</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
&#160;
        <span class="kw1">return</span> <span class="re0">$mime</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span>
&#160;
<span class="co2">#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</span><span class="co2"># php main (test section)
</span><span class="co2">#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
</span>
<span class="re0">$type</span> <span class="sy0">=</span> <span class="kw3">mime_content_type</span><span class="br0">&#40;</span><span class="st_h">'image.jpg'</span><span class="sy0">,</span> <span class="re0">$errortxt</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
<span class="co2">## Ausgabe im Browser vorbereiten
</span><span class="kw3">header</span><span class="br0">&#40;</span><span class="st_h">'content-type: text/plain'</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
<span class="kw3">var_dump</span><span class="br0">&#40;</span><span class="re0">$type</span><span class="br0">&#41;</span> <span class="sy0">.</span> <span class="st0">&quot;<span class="es1">\r</span><span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
<span class="kw3">var_dump</span><span class="br0">&#40;</span><span class="re0">$errortxt</span><span class="br0">&#41;</span> <span class="sy0">.</span> <span class="st0">&quot;<span class="es1">\r</span><span class="es1">\n</span>&quot;</span><span class="sy0">;</span>
&#160;
<span class="sy1">?&gt;</span></pre></div></div></div>
</div>
<p><br />
Die Funktion leistet nun ungefähr das Gleiche, wie das Original aus PHP. Das Verhalten unter Windows (Fehlermeldungen) 
ist jedoch noch nicht abgesichert...
</p><p>Unter der Verwendung von <code>finfo()</code> kann man sich die notwendigen Schritte auch zu einer Funktion zusammenfassen:
</p>
<div class="note-box note-box-example vorlage_beispiel">
<div class="note-box-title">Beispiel
</div>
<div class="note-box-text note-box-example-code"><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="php source-php"><pre class="de1"><span class="co2">### Beispielfunktion unter Verwendung von finfo() ###
</span>
<span class="kw2">function</span> get_mime_type<span class="br0">&#40;</span><span class="re0">$path</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
	<span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">version_compare</span><span class="br0">&#40;</span><span class="kw4">PHP_VERSION</span><span class="sy0">,</span> <span class="st_h">'5.3.0'</span><span class="br0">&#41;</span> <span class="sy0">&lt;</span> <span class="nu0">0</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span>	
	<span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">function_exists</span><span class="br0">&#40;</span><span class="st_h">'finfo_open'</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span>
&#160;
	<span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$finfo</span> <span class="sy0">=</span> <span class="kw3">finfo_open</span><span class="br0">&#40;</span>FILEINFO_MIME_TYPE<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span>
	<span class="re0">$mime_type</span> <span class="sy0">=</span> <span class="kw3">finfo_file</span><span class="br0">&#40;</span><span class="re0">$finfo</span><span class="sy0">,</span> <span class="re0">$path</span><span class="br0">&#41;</span><span class="sy0">;</span>
	<span class="kw3">finfo_close</span><span class="br0">&#40;</span><span class="re0">$finfo</span><span class="br0">&#41;</span><span class="sy0">;</span>	
&#160;
	<span class="kw1">return</span> <span class="re0">$mime_type</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></div></div></div>
</div>
<p><br />
Beim Abspeichern der Datei sollte man ihr eine Extension geben, die auf den MIME-Type rückschließen lässt. <b>Diese Extension, bzw. der MIME-Type sollten in einer Positivliste erlaubter Typen enthalten sein.</b> Die Webserver starten üblicherweise diverse Handler über die Dateiendungen.
</p><p>Eindeutig falsche Extensions sollten auf jeden Fall ersetzt werden durch solche, die eher zutreffend sind. Sind diese dann nicht in der Positivliste enthalten, gehört das File in die Quarantäne! (Dazu auch mehr unter <a href="#Bilder_erkennen">Bilder erkennen</a>).
</p>
<div class="note-box note-box-info"><p class="note-box-title">Information:</p><div class="note-box-text">siehe hierzu auch <a href="http://wiki.selfhtml.org/wiki/Referenz:MIME-Typen" title="Referenz:MIME-Typen"> SelfHTML 'MIME-Typen'</a></div></div>
<p>Eine ausschließlich schreibintensive Funktion, mit der man aus dem eben ermittelten MIME-Type auch _eine_ (von mehreren möglichen) passende Dateiendung ermitteln kann, folgt hier:
</p>
<div class="note-box note-box-example vorlage_beispiel">
<div class="note-box-title">Beispiel
</div>
<div class="note-box-text note-box-example-code"><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="php source-php"><pre class="de1"><span class="co2">### Mögliche Extension aus dem MIME-Type ermitteln
</span>
<span class="kw2">function</span> mime_to_ext<span class="br0">&#40;</span><span class="re0">$mime_type</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/acad'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'dwg'</span><span class="sy0">;</span>	<span class="co2">#		AutoCAD
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/applefile'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span> 		<span class="co2"># 		AppleFile-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/astound'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'asd'</span><span class="sy0">;</span>	<span class="co2"># *.asn 	Astound-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/dsptype'</span><span class="br0">&#93;</span>  		<span class="sy0">=</span> <span class="st_h">'tsp'</span><span class="sy0">;</span> 	<span class="co2"># 		TSP-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/dxf'</span><span class="br0">&#93;</span>		 	<span class="sy0">=</span> <span class="st_h">'dxf'</span><span class="sy0">;</span> 	<span class="co2">#		AutoCAD-Dateien (nach CERN)
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/futuresplash'</span><span class="br0">&#93;</span> 	<span class="sy0">=</span> <span class="st_h">'spl'</span><span class="sy0">;</span> 	<span class="co2">#		Flash Futuresplash-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/gzip'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'gz'</span><span class="sy0">;</span>	 	<span class="co2">#		GNU Zip-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/listenup'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'ptlk'</span><span class="sy0">;</span> 	<span class="co2">#		Listenup-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/mac-binhex40'</span><span class="br0">&#93;</span>		<span class="sy0">=</span> <span class="st_h">'hqx'</span><span class="sy0">;</span> 	<span class="co2">#		Macintosh Binärdateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/mbedlet'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'mbd'</span><span class="sy0">;</span> 	<span class="co2">#		Mbedlet-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/mif'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'mif'</span><span class="sy0">;</span> 	<span class="co2">#		FrameMaker Interchange Format Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/msexcel'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'xls'</span><span class="sy0">;</span> 	<span class="co2"># *.xla 	Microsoft Excel Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/mshelp'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'hlp'</span><span class="sy0">;</span> 	<span class="co2"># *.chm 	Microsoft Windows Hilfe Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/mspowerpoint'</span><span class="br0">&#93;</span> 	<span class="sy0">=</span> <span class="st_h">'ppt'</span><span class="sy0">;</span> 	<span class="co2"># *.ppz *.pps *.pot 	Microsoft Powerpoint Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/msword'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'doc'</span><span class="sy0">;</span> 	<span class="co2"># *.dot 	Microsoft Word Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/octet-stream'</span><span class="br0">&#93;</span> 	<span class="sy0">=</span> <span class="st_h">'bin'</span><span class="sy0">;</span> 	<span class="co2"># *.exe *.com *.dll *.class 	Ausführbare Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/oda'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'oda'</span><span class="sy0">;</span> 	<span class="co2"># 		Oda-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/pdf'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'pdf'</span><span class="sy0">;</span> 	<span class="co2">#		Adobe PDF-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/postscript'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'ai'</span><span class="sy0">;</span> 	<span class="co2"># *.eps *.ps 	Adobe PostScript-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/rtc'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'rtc'</span><span class="sy0">;</span> 	<span class="co2">#		RTC-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/rtf'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'rtf'</span><span class="sy0">;</span> 	<span class="co2"># 		Microsoft RTF-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/studiom'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'smp'</span><span class="sy0">;</span> 	<span class="co2">#		Studiom-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/toolbook'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'tbk'</span><span class="sy0">;</span> 	<span class="co2">#		Toolbook-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/vocaltec-media-desc'</span><span class="br0">&#93;</span> 	<span class="sy0">=</span> <span class="st_h">'vmd'</span><span class="sy0">;</span> 	<span class="co2">#		Vocaltec Mediadesc-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/vocaltec-media-file'</span><span class="br0">&#93;</span> 	<span class="sy0">=</span> <span class="st_h">'vmf'</span><span class="sy0">;</span> 	<span class="co2">#		Vocaltec Media-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/xhtml+xml'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'htm'</span><span class="sy0">;</span> 	<span class="co2"># *.html *.shtml *.xhtml 	XHTML-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/xml'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'xml'</span><span class="sy0">;</span> 	<span class="co2">#		XML-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-bcpio'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'bcpio'</span><span class="sy0">;</span> 	<span class="co2"># 		BCPIO-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-compress'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'z'</span><span class="sy0">;</span> 		<span class="co2">#		zlib-komprimierte Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-cpio'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'cpio'</span><span class="sy0">;</span> 	<span class="co2"># 		CPIO-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-csh'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'csh'</span><span class="sy0">;</span> 	<span class="co2">#		C-Shellscript-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-director'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'dcr'</span><span class="sy0">;</span> 	<span class="co2"># *.dir *.dxr 	Macromedia Director-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-dvi'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'dvi'</span><span class="sy0">;</span> 	<span class="co2">#		DVI-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-envoy'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'evy'</span><span class="sy0">;</span> 	<span class="co2">#		Envoy-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-gtar'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'gtar'</span><span class="sy0">;</span> 	<span class="co2"># 		GNU tar-Archivdateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-hdf'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'hdf'</span><span class="sy0">;</span> 	<span class="co2">#		HDF-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-httpd-php'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'php'</span><span class="sy0">;</span>	<span class="co2"># *.phtml 	PHP-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-javascript'</span><span class="br0">&#93;</span> 	<span class="sy0">=</span> <span class="st_h">'js'</span><span class="sy0">;</span> 	<span class="co2">#		serverseitige JavaScript-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-latex'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'latex'</span><span class="sy0">;</span> 	<span class="co2">#		LaTeX-Quelldateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-macbinary'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'bin'</span><span class="sy0">;</span> 	<span class="co2">#		Macintosh Binärdateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-mif'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'mif'</span><span class="sy0">;</span> 	<span class="co2"># 		FrameMaker Interchange Format Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-netcdf'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'nc'</span><span class="sy0">;</span> 	<span class="co2"># *.cdf 	Unidata CDF-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-nschat'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'nsc'</span><span class="sy0">;</span> 	<span class="co2"># 		NS Chat-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-sh'</span><span class="br0">&#93;</span> 	    	<span class="sy0">=</span> <span class="st_h">'sh'</span><span class="sy0">;</span> 	<span class="co2">#		Bourne Shellscript-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-shar'</span><span class="br0">&#93;</span> 	    	<span class="sy0">=</span> <span class="st_h">'shar'</span><span class="sy0">;</span> 	<span class="co2">#		Shell-Archivdateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-shockwave-flash'</span><span class="br0">&#93;</span> 	<span class="sy0">=</span> <span class="st_h">'swf'</span><span class="sy0">;</span>	<span class="co2"># *.cab Flash Shockwave-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-sprite'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'spr'</span><span class="sy0">;</span> 	<span class="co2"># *.sprite 	Sprite-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-stuffit'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'sit'</span><span class="sy0">;</span> 	<span class="co2">#		Stuffit-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-supercard'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'sca'</span><span class="sy0">;</span> 	<span class="co2">#		Supercard-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-sv4cpio'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'sv4cpio'</span><span class="sy0">;</span> 	<span class="co2"># 		CPIO-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-sv4crc'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'sv4crc'</span><span class="sy0">;</span> 	<span class="co2"># 		CPIO-Dateien mit CRC
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-tar'</span><span class="br0">&#93;</span> 	    	<span class="sy0">=</span> <span class="st_h">'tar'</span><span class="sy0">;</span> 	<span class="co2">#		tar-Archivdateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-tcl'</span><span class="br0">&#93;</span> 	   	<span class="sy0">=</span> <span class="st_h">'tcl'</span><span class="sy0">;</span> 	<span class="co2">#		TCL Scriptdateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-tex'</span><span class="br0">&#93;</span> 	    	<span class="sy0">=</span> <span class="st_h">'tex'</span><span class="sy0">;</span>	<span class="co2"># 		TeX-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-texinfo'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'texinfo'</span><span class="sy0">;</span> 	<span class="co2"># *.texi 	Texinfo-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-troff'</span><span class="br0">&#93;</span> 	    	<span class="sy0">=</span> <span class="st_h">'t'</span><span class="sy0">;</span> 		<span class="co2"># *.tr *.roff 	TROFF-Dateien (Unix)
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-troff-man'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'man'</span><span class="sy0">;</span> 	<span class="co2"># *.troff 	TROFF-Dateien mit MAN-Makros (Unix)
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-troff-me'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'me'</span><span class="sy0">;</span> 	<span class="co2"># *.troff 	TROFF-Dateien mit ME-Makros (Unix)
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-troff-ms'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'me'</span><span class="sy0">;</span> 	<span class="co2"># *.troff 	TROFF-Dateien mit MS-Makros (Unix)
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-ustar'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'ustar'</span><span class="sy0">;</span> 	<span class="co2"># 		tar-Archivdateien (Posix)
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-wais-source'</span><span class="br0">&#93;</span> 	<span class="sy0">=</span> <span class="st_h">'src'</span><span class="sy0">;</span> 	<span class="co2"># 		WAIS Quelldateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/x-www-form-urlencoded'</span><span class="br0">&#93;</span> <span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span>		<span class="co2">#  		HTML-Formulardaten an CGI
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/zip'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'zip'</span><span class="sy0">;</span> 	<span class="co2"># 		ZIP-Archivdateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'audio/basic'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'au'</span><span class="sy0">;</span> 	<span class="co2"># *.snd 	Sound-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'audio/echospeech'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'es'</span><span class="sy0">;</span> 	<span class="co2">#		Echospeed-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'audio/tsplayer'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'tsi'</span><span class="sy0">;</span> 	<span class="co2"># 		TS-Player-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'audio/voxware'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'vox'</span><span class="sy0">;</span> 	<span class="co2"># 		Vox-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'audio/x-aiff'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'aif'</span><span class="sy0">;</span> 	<span class="co2"># *.aiff *.aifc AIFF-Sound-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'audio/x-dspeeh'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'dus'</span><span class="sy0">;</span> 	<span class="co2"># *.cht 	Sprachdateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'audio/x-midi'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'mid'</span><span class="sy0">;</span> 	<span class="co2"># *.midi 	MIDI-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'audio/x-mpeg'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'mp2'</span><span class="sy0">;</span> 	<span class="co2">#		MPEG-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'audio/x-pn-realaudio'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'ram'</span><span class="sy0">;</span> 	<span class="co2"># *.ra 		RealAudio-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'audio/x-pn-realaudio-plugin'</span><span class="br0">&#93;</span> 	<span class="sy0">=</span> <span class="st_h">'rpm'</span><span class="sy0">;</span> 	<span class="co2"># 		RealAudio-Plugin-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'audio/x-qt-stream'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'stream'</span><span class="sy0">;</span> 	<span class="co2"># 		Quicktime-Streaming-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'audio/x-wav'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'wav'</span><span class="sy0">;</span> 	<span class="co2">#		WAV-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'drawing/x-dwf'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'dwf'</span><span class="sy0">;</span> 	<span class="co2"># 		Drawing-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'image/cis-cod'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'cod'</span><span class="sy0">;</span> 	<span class="co2"># 		CIS-Cod-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'image/cmu-raster'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'ras'</span><span class="sy0">;</span> 	<span class="co2">#		CMU-Raster-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'image/fif'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'fif'</span><span class="sy0">;</span> 	<span class="co2"># 		FIF-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'image/gif'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'gif'</span><span class="sy0">;</span> 	<span class="co2">#		GIF-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'image/ief'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'ief'</span><span class="sy0">;</span> 	<span class="co2">#		IEF-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'image/jpeg'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'jpg'</span><span class="sy0">;</span>     	<span class="co2"># *.jpeg *.jpe 	JPEG-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'image/png'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'png'</span><span class="sy0">;</span> 	<span class="co2"># 		PNG-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'image/tiff'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'tif'</span><span class="sy0">;</span>        <span class="co2"># *.tiff  	TIFF-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'image/vasa'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'mcf'</span><span class="sy0">;</span> 	<span class="co2"># 		Vasa-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'image/vnd.wap.wbmp'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'wbmp'</span><span class="sy0">;</span> 	<span class="co2"># 		Bitmap-Dateien (WAP)
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'image/x-freehand'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'fh4'</span><span class="sy0">;</span> 	<span class="co2"># *.fh5 *.fhc 	Freehand-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'image/x-icon'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'ico'</span><span class="sy0">;</span> 	<span class="co2"># 		Icon-Dateien (z.B. Favoriten-Icons)
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'image/x-portable-anymap'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'pnm'</span><span class="sy0">;</span> 	<span class="co2"># 		PBM Anymap Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'image/x-portable-bitmap'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'pbm'</span><span class="sy0">;</span> 	<span class="co2"># 		PBM Bitmap Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'image/x-portable-graymap'</span><span class="br0">&#93;</span> 	<span class="sy0">=</span> <span class="st_h">'pgm'</span><span class="sy0">;</span> 	<span class="co2"># 		PBM Graymap Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'image/x-portable-pixmap'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'ppm'</span><span class="sy0">;</span> 	<span class="co2"># 		PBM Pixmap Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'image/x-rgb'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'rgb'</span><span class="sy0">;</span> 	<span class="co2"># 		RGB-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'image/x-windowdump'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'xwd'</span><span class="sy0">;</span> 	<span class="co2"># 		X-Windows Dump
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'image/x-xbitmap'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'xbm'</span><span class="sy0">;</span> 	<span class="co2"># 		XBM-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'image/x-xpixmap'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'xpm'</span><span class="sy0">;</span> 	<span class="co2"># 		XPM-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'message/external-body'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span> 		<span class="co2"># 		Nachricht mit externem Inhalt
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'message/http'</span><span class="br0">&#93;</span> 	  		<span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span>		<span class="co2"># 		HTTP-Headernachricht
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'message/news'</span><span class="br0">&#93;</span> 	  		<span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span>		<span class="co2"># 		Newsgroup-Nachricht
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'message/partial'</span><span class="br0">&#93;</span> 	  		<span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span>		<span class="co2"># 		Nachricht mit Teilinhalt
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'message/rfc822'</span><span class="br0">&#93;</span> 	  		<span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span>		<span class="co2"># 		Nachricht nach RFC 2822
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'model/vrml'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'wrl'</span><span class="sy0">;</span> 	<span class="co2"># 		Visualisierung virtueller Welten (VRML)
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'multipart/alternative'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span>  		<span class="co2"># 		mehrteilige Daten gemischt
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'multipart/byteranges'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span>  		<span class="co2"># 		mehrteilige Daten mit Byte-Angaben
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'multipart/digest'</span><span class="br0">&#93;</span> 	  	<span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span>		<span class="co2"># 		mehrteilige Daten / Auswahl
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'multipart/encrypted'</span><span class="br0">&#93;</span> 	  	<span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span>		<span class="co2"># 		mehrteilige Daten verschlüsselt
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'multipart/form-data'</span><span class="br0">&#93;</span> 	  	<span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span>		<span class="co2"># 		mehrteilige Daten aus HTML-Formular (z.B. File-Upload)
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'multipart/mixed'</span><span class="br0">&#93;</span> 	  		<span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span>		<span class="co2"># 		mehrteilige Daten gemischt
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'multipart/parallel'</span><span class="br0">&#93;</span> 	  	<span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span>		<span class="co2"># 		mehrteilige Daten parallel
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'multipart/related'</span><span class="br0">&#93;</span> 	  	<span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span>		<span class="co2"># 		mehrteilige Daten / verbunden
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'multipart/report'</span><span class="br0">&#93;</span> 	  	<span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span>		<span class="co2"># 		mehrteilige Daten / Bericht
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'multipart/signed'</span><span class="br0">&#93;</span> 	  	<span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span>		<span class="co2"># 		mehrteilige Daten / bezeichnet
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'multipart/voice-message'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span>  		<span class="co2"># 		mehrteilige Daten / Sprachnachricht
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'text/comma-separated-values'</span><span class="br0">&#93;</span> 	<span class="sy0">=</span> <span class="st_h">'csv'</span><span class="sy0">;</span> 	<span class="co2"># 		kommaseparierte Datendateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'text/css'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'css'</span><span class="sy0">;</span> 	<span class="co2"># 		CSS Stylesheet-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'text/html'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'htm'</span><span class="sy0">;</span> 	<span class="co2"># *.html *.shtml 	HTML-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'text/javascript'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'js'</span><span class="sy0">;</span>		<span class="co2"># 		JavaScript-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'text/plain'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'txt'</span><span class="sy0">;</span> 	<span class="co2"># 		reine Textdateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'text/richtext'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'rtx'</span><span class="sy0">;</span> 	<span class="co2"># 		Richtext-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'text/rtf'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'rtf'</span><span class="sy0">;</span>	<span class="co2"># 		Microsoft RTF-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'text/x-php'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'php'</span><span class="sy0">;</span>	<span class="co2"># 		PHP-Script-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'text/tab-separated-values'</span><span class="br0">&#93;</span> 	<span class="sy0">=</span> <span class="st_h">'tsv'</span><span class="sy0">;</span> 	<span class="co2"># 		tabulator-separierte Datendateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'text/vnd.wap.wml'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'wml'</span><span class="sy0">;</span> 	<span class="co2"># 		WML-Dateien (WAP)
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/vnd.wap.wmlc'</span><span class="br0">&#93;</span> 	<span class="sy0">=</span> <span class="st_h">'wmlc'</span><span class="sy0">;</span> 	<span class="co2"># 		WMLC-Dateien (WAP)
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'text/vnd.wap.wmlscript'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'wmls'</span><span class="sy0">;</span> 	<span class="co2"># 		WML-Scriptdateien (WAP)
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'application/vnd.wap.wmlscriptc'</span><span class="br0">&#93;</span> 	<span class="sy0">=</span> <span class="st_h">'wmlsc'</span><span class="sy0">;</span> 	<span class="co2"># 		WML-Script-C-dateien (WAP)
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'text/xml'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'xml'</span><span class="sy0">;</span> 	<span class="co2"># 		XML-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'text/xml-external-parsed-entity'</span><span class="br0">&#93;</span>  <span class="sy0">=</span> <span class="st_h">''</span><span class="sy0">;</span> 		<span class="co2"># 		extern geparste XML-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'text/x-setext'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'etx'</span><span class="sy0">;</span> 	<span class="co2"># 		SeText-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'text/x-sgml'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'sgm'</span><span class="sy0">;</span> 	<span class="co2"># *.sgml 	SGML-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'text/x-speech'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'talk'</span><span class="sy0">;</span> 	<span class="co2"># *.spc 	Speech-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'video/mpeg'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'mpeg'</span><span class="sy0">;</span> 	<span class="co2"># *.mpg *.mpe 	MPEG-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'video/quicktime'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'qt'</span><span class="sy0">;</span> 	<span class="co2"># *.mov 	Quicktime-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'video/vnd.vivo'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'viv'</span><span class="sy0">;</span> 	<span class="co2"># *.vivo 	Vivo-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'video/x-msvideo'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'avi'</span><span class="sy0">;</span> 	<span class="co2"># Microsoft AVI-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'video/x-sgi-movie'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'movie'</span><span class="sy0">;</span> 	<span class="co2"># Movie-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'workbook/formulaone'</span><span class="br0">&#93;</span> 		<span class="sy0">=</span> <span class="st_h">'vts'</span><span class="sy0">;</span> 	<span class="co2"># *.vtts 	FormulaOne-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'x-world/x-3dmf'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'3dmf'</span><span class="sy0">;</span> 	<span class="co2"># *.3dm *.qd3d *.qd3 	3DMF-Dateien
</span>	<span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="st_h">'x-world/x-vrml'</span><span class="br0">&#93;</span> 			<span class="sy0">=</span> <span class="st_h">'wrl'</span><span class="sy0">;</span>	<span class="co2">#&#160;?
</span>
        <span class="co2">### hier proprietäre MIME-Types einfügen
</span>	
	<span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="re0">$mime_type</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
	<span class="br0">&#123;</span>
		<span class="kw1">return</span> <span class="re0">$_mimetypes</span><span class="br0">&#91;</span><span class="re0">$mime_type</span><span class="br0">&#93;</span><span class="sy0">;</span>
	<span class="br0">&#125;</span>
&#160;
	<span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span>
&#160;
<span class="br0">&#125;</span></pre></div></div></div>
</div>
<div class="note-box note-box-todo"><p class="note-box-title">ToDo:&#160;&#160;&#160;&#160;<span class="note-box-more small">(<a href="http://wiki.selfhtml.org/wiki/Kategorie:ToDo" title="Kategorie:ToDo"><span style="color:#eef;text-decoration:underline">weitere ToDos</span></a>)</span></p><div class="note-box-text">
<p>[Proprietäre MIME-Types in die Funktion mime_to_ext() einbauen als include()]
</p>
</div></div>
<p><br />
</p>
<h4><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=13" title="Abschnitt bearbeiten: Bilder erkennen">Bearbeiten</a>]</span> <span class="mw-headline" id="Bilder_erkennen">Bilder erkennen</span></h4>
<p>Das Erkennen eines Bildes ist bei PHP relativ sicher durch die Funktion <code>getimagesize()</code> (<a rel="nofollow" class="external text" href="http://de2.php.net/manual/de/function.getimagesize.php">Handbuch</a>) möglich. Diese Funktion gehört zum Standardumfang von PHP, steht also auch zur Verfügung, wenn keine Grafik-Erweiterungen, wie z.B. GD-Lib oder ImageMagick installiert wurden. 
</p><p>Wird mittels <code>getimagesize()</code> ein Bildformat erkannt, kann dieses Bild allerdings immer noch schädlich für den Server sein. Es könnte
</p>
<ul><li> Schadcode enthalten (z.B. im EXIF-Header)
</li><li> eine Dateiendung haben, die zum Parsen des Codes führt
</li></ul>
<p>Um ohne Angst Bilder auf den Server hochladen lassen zu können, sollte man daher beim Weiterverarbeiten auf dem Server die folgenden Regeln beachten:
</p>
<ul><li> nur Dateinamen (nebst Pfadprüfung bzw. Abtrennung mit <code>basename()</code>, <a rel="nofollow" class="external text" href="http://de3.php.net/manual/en/function.basename.php">Handbuch</a>) mit Endungen aus einer Positivliste zulassen, besser noch, den Dateinamen auf dem Server generieren. <b>Siehe hierzu auch den Abschnitt "Schädliche Dateinamen ausschließen"</b> 
</li><li> für Verzeichnisse, die hochgeladene Bilder direkt über HTTP(S) bereitstellen, sämtliche Interpreter, bin- und  exe-Loader ausschalten, sodass durch die Files keinerlei Programmkontrolle erlangt werden kann
</li><li> Für die abgelegten Dateien keinesfalls das Execute-Recht setzen (<b>maximal rw-rw-r--</b>  664,  <i>rwxrwxrwx  777 ist böse!</i>).
</li><li> nur Bilder zulassen, also Prüfung mit <code>getimagesize()</code> (<a rel="nofollow" class="external text" href="http://de3.php.net/manual/en/function.getimagesize.php">Handbuch</a>)
</li><li> Dateiendungen nach Prüfung mit <code>getimagesize(), $_imagesize['mime'] (s. nachfolgend) oder get_mime_type() und mime_to_ext()</code> richtigstellen
</li></ul>
<p>Die serverseitige Verwendung des vom Client gemeldeten MIME-Types in <code>$_FILES['inputname']['type']</code> ist für die Absicherung <b>nicht</b> geeignet, da diese Angabe beliebig gefälscht sein kann.
</p>
<h5><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=14" title="Abschnitt bearbeiten: Der Wert von getimagesize()">Bearbeiten</a>]</span> <span class="mw-headline" id="Der_Wert_von_getimagesize.28.29">Der Wert von <code>getimagesize()</code></span></h5>
<p>Beim Hochladen von Bildern sollte man alle möglichen Kontrollmechanismen verwenden. Bilder können als Hintertür missbraucht werden.
</p><p>Mit der PHP-Funktion <code>getimagesize()</code> (<a rel="nofollow" class="external text" href="http://de.php.net/manual/en/function.getimagesize.php">Handbuch</a>) kann man auf dem Server prüfen, welchen MIME-Type das hochgeladene Bild hat. Außerdem kann man weitere Metadaten des Bildes erfahren:
</p>
<div class="note-box note-box-example vorlage_beispiel">
<div class="note-box-title">Beispiel
</div>
<div class="note-box-text note-box-example-code"><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="php source-php"><pre class="de1"><span class="re0">$_imagesize</span> <span class="sy0">=</span> <span class="kw3">getimagesize</span><span class="br0">&#40;</span><span class="re0">$_FILES</span><span class="br0">&#91;</span><span class="st_h">'dateiupload'</span><span class="br0">&#93;</span><span class="br0">&#91;</span><span class="st_h">'tmp_name'</span><span class="br0">&#93;</span><span class="sy0">,</span> <span class="re0">$_imageinfo</span><span class="br0">&#41;</span><span class="sy0">;</span></pre></div></div></div>
</div>
<p>Die Funktion gibt entweder ein Array zurück, das aber nicht immer alle Elemente enthalten muss
</p>
<ul><li> $_imagesize[0] =&gt; Breite des Bildes in Pixeln
</li><li> $_imagesize[1] =&gt; Höhe des Bildes in Pixeln
</li><li> $_imagesize[2] =&gt; Enthält einen numerischen Wert für den Bildtyp. (siehe Konstanten)
</li><li> $_imagesize[3] =&gt; Enthält einen String für die Verwendug in HTML, leider für CSS nicht verwendbar
</li><li> $_imagesize['mime'] =&gt; Enthält den MIME-Type des Bildes laut RFC
</li><li> $_imagesize['channels'] =&gt; Enthält die Anzahl der Farbkanäle (also z.B. wieviel Bytes ein Pixel beansprucht)
</li><li> $_imagesize['bits'] =&gt; Enthält die Anzahl der Bits pro Farbkanal
</li></ul>
<p>oder im Misserfolgsfall 'FALSE'.
</p><p>Die Imagetype-Konstanten aus <b>$_imagesize[2]</b> lauten: 
</p>
<ul><li>    [IMAGETYPE_GIF] =&gt; 1
</li><li>    [IMAGETYPE_JPEG] =&gt; 2
</li><li>    [IMAGETYPE_PNG] =&gt; 3
</li><li>    [IMAGETYPE_SWF] =&gt; 4
</li><li>    [IMAGETYPE_PSD] =&gt; 5
</li><li>    [IMAGETYPE_BMP] =&gt; 6
</li><li>    [IMAGETYPE_TIFF_II] =&gt; 7
</li><li>    [IMAGETYPE_TIFF_MM] =&gt; 8
</li><li>    [IMAGETYPE_JPC] =&gt; 9
</li><li>    [IMAGETYPE_JP2] =&gt; 10
</li><li>    [IMAGETYPE_JPX] =&gt; 11
</li><li>    [IMAGETYPE_JB2] =&gt; 12
</li><li>    [IMAGETYPE_SWC] =&gt; 13
</li><li>    [IMAGETYPE_IFF] =&gt; 14
</li><li>    [IMAGETYPE_WBMP] =&gt; 15
</li><li>    [IMAGETYPE_JPEG2000] =&gt; 9
</li><li>    [IMAGETYPE_XBM] =&gt; 16
</li></ul>
<p>Es stehen also die <b>Werte</b> zu den zugehörigen Konstanten in $_imagesize[2].
</p><p>Wird von der Funktion <code>getimagesize()</code> keiner der vorbenannten Typen erkannt, liefert sie <b>false</b> zurück.
</p><p>Um aus dem Imagetype wieder eine File-Extension zu machen, schreiben wir uns wieder eine kleine Nachschlagefunktion:
</p>
<div class="note-box note-box-example vorlage_beispiel">
<div class="note-box-title">Beispiel
</div>
<div class="note-box-text note-box-example-code"><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="php source-php"><pre class="de1"><span class="co2">## File-Extension aus dem Imagetype erzeugen
</span>
<span class="kw2">function</span> get_img_file_ext<span class="br0">&#40;</span><span class="re0">$imagetype</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="kw1">if</span><span class="br0">&#40;</span><span class="re0">$imagetype</span> <span class="sy0">===</span> <span class="kw4">false</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span>
&#160;
    <span class="re0">$_types</span><span class="br0">&#91;</span>IMAGETYPE_GIF<span class="br0">&#93;</span>     <span class="sy0">=</span> <span class="st_h">'gif'</span><span class="sy0">;</span>
    <span class="re0">$_types</span><span class="br0">&#91;</span>IMAGETYPE_JPEG<span class="br0">&#93;</span>    <span class="sy0">=</span> <span class="st_h">'jpg'</span><span class="sy0">;</span>
    <span class="re0">$_types</span><span class="br0">&#91;</span>IMAGETYPE_PNG<span class="br0">&#93;</span>     <span class="sy0">=</span> <span class="st_h">'png'</span><span class="sy0">;</span>
    <span class="re0">$_types</span><span class="br0">&#91;</span>IMAGETYPE_SWF<span class="br0">&#93;</span>     <span class="sy0">=</span> <span class="st_h">'swf'</span><span class="sy0">;</span>
    <span class="re0">$_types</span><span class="br0">&#91;</span>IMAGETYPE_PSD<span class="br0">&#93;</span>     <span class="sy0">=</span> <span class="st_h">'psd'</span><span class="sy0">;</span>
    <span class="re0">$_types</span><span class="br0">&#91;</span>IMAGETYPE_BMP<span class="br0">&#93;</span>     <span class="sy0">=</span> <span class="st_h">'bmp'</span><span class="sy0">;</span>
    <span class="re0">$_types</span><span class="br0">&#91;</span>IMAGETYPE_TIFF_II<span class="br0">&#93;</span> <span class="sy0">=</span> <span class="st_h">'tif'</span><span class="sy0">;</span>
    <span class="re0">$_types</span><span class="br0">&#91;</span>IMAGETYPE_TIFF_MM<span class="br0">&#93;</span> <span class="sy0">=</span> <span class="st_h">'tif'</span><span class="sy0">;</span>
    <span class="re0">$_types</span><span class="br0">&#91;</span>IMAGETYPE_JPC<span class="br0">&#93;</span>     <span class="sy0">=</span> <span class="st_h">'jpc'</span><span class="sy0">;</span>
    <span class="re0">$_types</span><span class="br0">&#91;</span>IMAGETYPE_JP2<span class="br0">&#93;</span>     <span class="sy0">=</span> <span class="st_h">'jp2'</span><span class="sy0">;</span>
    <span class="re0">$_types</span><span class="br0">&#91;</span>IMAGETYPE_JPX<span class="br0">&#93;</span>     <span class="sy0">=</span> <span class="st_h">'jpx'</span><span class="sy0">;</span>
    <span class="re0">$_types</span><span class="br0">&#91;</span>IMAGETYPE_JB2<span class="br0">&#93;</span>     <span class="sy0">=</span> <span class="st_h">'jb2'</span><span class="sy0">;</span>
    <span class="re0">$_types</span><span class="br0">&#91;</span>IMAGETYPE_SWC<span class="br0">&#93;</span>     <span class="sy0">=</span> <span class="st_h">'swc'</span><span class="sy0">;</span>
    <span class="re0">$_types</span><span class="br0">&#91;</span>IMAGETYPE_IFF<span class="br0">&#93;</span>     <span class="sy0">=</span> <span class="st_h">'iff'</span><span class="sy0">;</span>
    <span class="re0">$_types</span><span class="br0">&#91;</span>IMAGETYPE_WBMP<span class="br0">&#93;</span>    <span class="sy0">=</span> <span class="st_h">'wbmp'</span><span class="sy0">;</span>
    <span class="re0">$_types</span><span class="br0">&#91;</span>IMAGETYPE_JPEG2000<span class="br0">&#93;</span> <span class="sy0">=</span> <span class="st_h">'jpg'</span><span class="sy0">;</span>
    <span class="re0">$_types</span><span class="br0">&#91;</span>IMAGETYPE_XBM<span class="br0">&#93;</span>     <span class="sy0">=</span> <span class="st_h">'xbm'</span><span class="sy0">;</span>
&#160;
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$_types</span><span class="br0">&#91;</span><span class="re0">$imagetype</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="re0">$_types</span><span class="br0">&#91;</span><span class="re0">$imagetype</span><span class="br0">&#93;</span><span class="sy0">;</span>
&#160;
    <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></div></div></div>
</div>
<p>Alternativ können wir die File-Extension auch mit Hilfe von <code>$_imagesize['mime']</code> und der schon vorgestellten Funktion <code>mime_to_ext()</code> ermitteln.
</p>
<h4><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=15" title="Abschnitt bearbeiten: Textdateien erkennen">Bearbeiten</a>]</span> <span class="mw-headline" id="Textdateien_erkennen">Textdateien erkennen</span></h4>
<div class="note-box note-box-todo"><p class="note-box-title">ToDo:&#160;&#160;&#160;&#160;<span class="note-box-more small">(<a href="http://wiki.selfhtml.org/wiki/Kategorie:ToDo" title="Kategorie:ToDo"><span style="color:#eef;text-decoration:underline">weitere ToDos</span></a>)</span></p><div class="note-box-text">
<p>[Reine Textdateien erkennen / Script-Ausschluss]
</p>
</div></div>
<p><br />
</p>
<h5><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=16" title="Abschnitt bearbeiten: Einfache Textformate">Bearbeiten</a>]</span> <span class="mw-headline" id="Einfache_Textformate">Einfache Textformate</span></h5>
<p>Unter Textdateien versteht man i.a. Dateien, die nur druckbare Zeichen enthalten nebst ein paar Druckersteuerzeichen und in der weiteren Entwicklung auch einigen Sonderzeichen unterschiedlicher (westeuropäischer) Sprachen. Grundsätzlich kann man erst einmal annehmen, dass alle Zeichen aus dem ASCII-Zeichensatz stammen müssen (weitere Ausführen siehe „höhere Textformate“).
</p><p>Diese Dateien können reinen Klartext (Plain Text), HTML, Programm-Quellcode oder sonstige Informationen enthalten, die so gestaltet sind, dass sie mittels eines einfachen <a rel="nofollow" class="external text" href="http://de.wikipedia.org/wiki/Texteditor">Texteditors</a> für Menschen lesbar sind.
</p><p>Betrachten wir zuerst reine Klartext-Dateien in ASCII-Codierung. Diese dürfen nur eine Untermenge des ASCII-Zeichensatzes enthalten, wenn sie in der Mehrzahl der Verarbeitungs- und Ausgabeumgebungen "unschädlich" sein sollen.
</p><p>Keinesfalls dürfen sie aber den binären Wert 0 enthalten. 
</p><p><br />
</p><p><br />
</p>
<table border="1" cellspacing="0" cellpadding="3">
<tr>
<th> Code
<p>dez.
</p>
</th>
<th> Code
<p>hexadez.
</p>
</th>
<th> Zeichendar-
<p>stellung
</p>
</th>
<th> Bedeutung
</th></tr>
<tr>
<td> 0
</td>
<td> 00
</td>
<td> 0
</td>
<td> NULL
</td></tr>
<tr>
<td> 1
</td>
<td> 01
</td>
<td>
</td>
<td>
</td></tr>
<tr>
<td> 2
</td>
<td>
</td>
<td>
</td>
<td>
</td></tr>
<tr>
<td> 3
</td>
<td>
</td>
<td>
</td>
<td>
</td></tr>
</table>
<p><br />
Wenn wir durch Vergleich mit einer <b>Positivliste</b> sichergestellt haben, dass es sich bei der hochgeladenen Datei um eine reine ASCII-Textdatei (ggf. zuzüglich Sonderzeichen) handelt, müssen wir trotzdem noch sicherstellen, dass diese Datei kein ausführbares Programm oder Script enthält, das auf dem Server Schaden anrichten kann.
</p><p>Eine weitere Schadenmöglichkeit besteht darin, dass diese Dateien Textsequenzen enthalten, die für den Client (hier den Browser des Betrachters) eine Steuerwirkung haben, die über die reine Druckersteuerung hinaus geht. Es könnten in einer Textdatei also zusätzliche Informationen im Format von
</p>
<ul><li> HTML
</li><li> JavaScript
</li><li> Java
</li><li> Visual Basic for Applications
</li><li> CSS (cascading style sheets)
</li><li> ...
</li></ul>
<p>versteckt sein, die dann durch den Browser des Betrachters interpretiert werden.
Lesen Sie hierzu am besten auch den <a href="http://wiki.selfhtml.org/wiki/Artikel:Kontextwechsel" title="Artikel:Kontextwechsel" class="mw-redirect">Artikel:Kontextwechsel</a>.
</p>
<h5><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=17" title="Abschnitt bearbeiten: Höhere Textformate">Bearbeiten</a>]</span> <span class="mw-headline" id="H.C3.B6here_Textformate">Höhere Textformate</span></h5>
<ul><li> andere Codierungen
</li><li> implizite Textformatierungen (z.B. RTF <a rel="nofollow" class="external autonumber" href="http://de.wikipedia.org/wiki/Rich_Text_Format">[1]</a>)
</li><li> ...
</li></ul>
<h3><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=18" title="Abschnitt bearbeiten: Schädliche Dateinamen ausschließen">Bearbeiten</a>]</span> <span class="mw-headline" id="Sch.C3.A4dliche_Dateinamen_ausschlie.C3.9Fen">Schädliche Dateinamen ausschließen</span></h3>
<p>Wenn Sie trotz der Warnungen einen vom Client gelieferten Dateinamen direkt zum Speichern der Datei auf dem Server verwenden wollen, müssen Sie unbedingt diverse Regeln beachten. Hier nochmals der Hinweis, dass eine Transformation in einer Datei oder Datenbanktabelle aus mehreren Gründen der bessere Weg ist!
</p><p><br />
</p>
<h4><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=19" title="Abschnitt bearbeiten: Für Windows-Zielsysteme gilt">Bearbeiten</a>]</span> <span class="mw-headline" id="F.C3.BCr_Windows-Zielsysteme_gilt">Für Windows-Zielsysteme gilt</span></h4>
<p>Verbotene Zeichen:
</p><p><code>
&lt; &gt;&#160;? "&#160;: | \ / * NULL
</code>
</p><p>NULL steht für ASCII #0.
</p><p><br />
Verbotene Dateinamen/Gerätebezeichnungen
</p><p><code>
CON, PRN, AUX, NUL
COM1, COM2, COM3, COM4, COM5, COM6, COM7, COM8, COM9
LPT1, LPT2, LPT3, LPT4, LPT5, LPT6, LPT7, LPT8, und LPT9.
</code>
</p>
<h4><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=20" title="Abschnitt bearbeiten: Für Linux-Zielsysteme gilt">Bearbeiten</a>]</span> <span class="mw-headline" id="F.C3.BCr_Linux-Zielsysteme_gilt">Für Linux-Zielsysteme gilt</span></h4>
<p>Verbotene Zeichen:
</p><p><code>
/  NULL
</code>
</p><p>NULL steht für ASCII #0.
</p><p><br />
<b>Verbotene Dateinamen/Gerätebezeichnungen</b>
</p><p>Bei Linux/Unix werden alle Devices als Dateinamen über das Filesystem angesprochen. Wir müssen also verhindern, dass entsprechende Dateinamen erzeugt werden können. Auch alle empfindlichen Dateien sollten nach dem FHS (File System Hierarchie Standard) in tieferen Verzeichnisebenen liegen.
</p>
<div class="note-box note-box-example vorlage_beispiel">
<div class="note-box-title">Beispiel
</div>
<div class="note-box-text note-box-example-code"><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="bash source-bash"><pre class="de1"><span class="sy0">/</span>dev<span class="sy0">/</span>sda1
<span class="sy0">/</span>etc<span class="sy0">/</span><span class="kw2">passwd</span>
<span class="sy0">/</span>usr<span class="sy0">/</span>bin<span class="sy0">/</span>useradd</pre></div></div></div>
</div>
<p><b>Tilde Expansion&#160;?</b>
</p><p>noch nicht weiter untersucht ...
</p><p>.
</p><p><b>Hochladen von Schlüsseln&#160;?</b>
</p><p>noch nicht weiter untersucht ...
</p><p>.
</p>
<h4><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=21" title="Abschnitt bearbeiten: Für PHP gilt zusätzlich">Bearbeiten</a>]</span> <span class="mw-headline" id="F.C3.BCr_PHP_gilt_zus.C3.A4tzlich">Für PHP gilt zusätzlich</span></h4>
<p><b>Verbotene Dateinamen:</b>
</p><p><code>
php://output&#160;; php://input&#160;; php://stdin&#160;; php://stdout&#160;; php://stderr  
</code>
</p>
<h4><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=22" title="Abschnitt bearbeiten: Für den Apache Webserver gilt">Bearbeiten</a>]</span> <span class="mw-headline" id="F.C3.BCr_den_Apache_Webserver_gilt">Für den Apache Webserver gilt</span></h4>
<p><b>Verbotene Dateinamen:</b>
</p><p><code>
.htaccess   ## ist abhängig von der Serverconfiguration!
</code>
</p>
<h4><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=23" title="Abschnitt bearbeiten: Dateinamen anpassen">Bearbeiten</a>]</span> <span class="mw-headline" id="Dateinamen_anpassen">Dateinamen anpassen</span></h4>
<p>Wenn wir nun die Schnittmenge des Erlaubten für DOS/Windows und Linux bilden, bleibt eigentlich für einen noch lesbaren, aber zulässigen Dateinamen nur eine Untermenge der druckbaren ASCII-Zeichen übrig. Diese müssen wir aber noch weiter einschränken und zusätzliche Regeln kontrollieren.
</p>
<ul><li> Anfangs-Codierung sicherstellen
</li><li> Umlaute entfernen bzw. ersetzen
</li><li> kein führender Punkt, kein Punkt am Ende
</li><li> keine Pfade zulassen ('\' und '/' entfernen bzw. austauschen) 
</li><li> alle nicht in einer Positivliste enthaltenen Zeichen ersetzen.
</li><li> Dateiendungen (*.ext) kontrollieren und ggf. ersetzen oder ablehnen
</li><li> Geschützte Dateinamen (Kanal- und Gerätenamen) verhindern
</li><li> ggf. Case Un/Sensitivity berücksichtigen
</li><li> ggf. auch Leerzeichen austauschen, obwohl diese in Dateinamen inzwischen erlaubt sind. Allerdings können wir den Schwierigkeiten in Referenzen (Links) hier bereits vorbeugen
</li></ul>
<p><br />
</p>
<div class="note-box note-box-example vorlage_beispiel">
<div class="note-box-title">Beispiel
</div>
<div class="note-box-text note-box-example-code"><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="php source-php"><pre class="de1"><span class="kw2">function</span> fname_filter<span class="br0">&#40;</span> <span class="re0">$s</span><span class="sy0">,</span> <span class="re0">$filter</span><span class="sy0">=</span><span class="kw4">true</span> <span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="co2">##@s: string, string to be filtered, must be encoded utf-8
</span>    <span class="co2">##@filter: boolean, true-&gt;filter $s for use as filename and remove 
</span>    <span class="co2">###   reserved expressions and signs for Windows, Linux, php, apache
</span>   
    <span class="co2">## Normalizer-class missing!
</span>    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span> <span class="kw3">class_exists</span><span class="br0">&#40;</span><span class="st0">&quot;Normalizer&quot;</span><span class="sy0">,</span> <span class="re0">$autoload</span> <span class="sy0">=</span> <span class="kw4">false</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span>
&#160;
    <span class="co2">## maps German (umlauts) and other European characters onto two characters before just removing diacritics
</span>    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{00c4}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;Ae&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// umlaut Ä =&gt; Ae</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{00d6}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;Oe&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// umlaut Ö =&gt; Oe</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{00dc}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;Ue&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// umlaut Ü =&gt; Ue</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{00e4}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;ae&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// umlaut ä =&gt; ae</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{00f6}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;oe&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// umlaut ö =&gt; oe</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{00fc}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;ue&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// umlaut ü =&gt; ue</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{00f1}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;ny&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// ñ =&gt; ny</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{00ff}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;yu&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// ÿ =&gt; yu</span>
&#160;
    <span class="co2">## maps special characters (characters with diacritics) on their base-character followed by the diacritical mark
</span>    <span class="co2">## exmaple:  Ú =&gt; U´,  á =&gt; a`
</span>    <span class="re0">$s</span>    <span class="sy0">=</span> Normalizer<span class="sy0">::</span><span class="me2">normalize</span><span class="br0">&#40;</span> <span class="re0">$s</span><span class="sy0">,</span> Normalizer<span class="sy0">::</span><span class="me2">FORM_D</span> <span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\pM@u'</span>        <span class="sy0">,</span> <span class="st0">&quot;&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// removes diacritics</span>
&#160;
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{00df}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;ss&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// maps German ß onto ss</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{00c6}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;Ae&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// Æ =&gt; Ae</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{00e6}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;ae&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// æ =&gt; ae</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{0132}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;Ij&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">//&#160;? =&gt; Ij</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{0133}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;ij&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">//&#160;? =&gt; ij</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{0152}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;Oe&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// Œ =&gt; Oe</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{0153}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;oe&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// œ =&gt; oe</span>
&#160;
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{00d0}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;D&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// Ð =&gt; D</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{0110}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;D&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// Ð =&gt; D</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{00f0}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;d&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// ð =&gt; d</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{0111}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;d&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// d =&gt; d</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{0126}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;H&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// H =&gt; H</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{0127}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;h&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// h =&gt; h</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{0131}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;i&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// i =&gt; i</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{0138}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;k&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">//&#160;? =&gt; k</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{013f}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;L&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">//&#160;? =&gt; L</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{0141}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;L&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// L =&gt; L</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{0140}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;l&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">//&#160;? =&gt; l</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{0142}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;l&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// l =&gt; l</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{014a}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;N&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">//&#160;? =&gt; N</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{0149}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;n&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">//&#160;? =&gt; n</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{014b}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;n&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">//&#160;? =&gt; n</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{00d8}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;O&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// Ø =&gt; O</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{00f8}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;o&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// ø =&gt; o</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{017f}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;s&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">//&#160;? =&gt; s</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{00de}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;T&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// Þ =&gt; T</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{0166}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;T&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// T =&gt; T</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{00fe}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;t&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// þ =&gt; t</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@\x{0167}@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;t&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>    <span class="co1">// t =&gt; t</span>
&#160;
    <span class="co1">// remove all non-ASCii characters</span>
    <span class="re0">$s</span>    <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span> <span class="st_h">'@[^\0-\x80]@u'</span>    <span class="sy0">,</span> <span class="st0">&quot;&quot;</span><span class="sy0">,</span>    <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
    <span class="co2">## remove all reserved expressions and signs for Windows, Linux, php, apache
</span>    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$filter</span> <span class="sy0">===</span> <span class="kw4">true</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
	<span class="re0">$_search</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="st_h">' '</span><span class="sy0">,</span> <span class="nu12">0x0</span><span class="sy0">,</span> <span class="st_h">'&lt;'</span><span class="sy0">,</span> <span class="st_h">'&gt;'</span><span class="sy0">,</span> <span class="st_h">'|'</span><span class="sy0">,</span> <span class="st_h">'?'</span><span class="sy0">,</span> <span class="st_h">'&quot;'</span><span class="sy0">,</span> <span class="st_h">':'</span><span class="sy0">,</span> <span class="st_h">'\\'</span><span class="sy0">,</span> <span class="st_h">'/'</span><span class="sy0">,</span> <span class="st_h">'*'</span><span class="br0">&#41;</span><span class="sy0">;</span> 
&#160;
	<span class="re0">$s</span> <span class="sy0">=</span> <span class="kw3">str_replace</span><span class="br0">&#40;</span> <span class="re0">$_search</span><span class="sy0">,</span> <span class="st_h">'_'</span><span class="sy0">,</span> <span class="re0">$s</span> <span class="br0">&#41;</span><span class="sy0">;</span> 
&#160;
        <span class="co2">## remove leading and trailing dot
</span>	<span class="re0">$s</span> <span class="sy0">=</span> <span class="kw3">trim</span><span class="br0">&#40;</span><span class="re0">$s</span><span class="sy0">,</span> <span class="st_h">'.'</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
	<span class="co2">## avoid reserved expressions
</span>	<span class="re0">$_names</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span> <span class="st_h">'CON'</span><span class="sy0">,</span> <span class="st_h">'PRN'</span><span class="sy0">,</span> <span class="st_h">'AUX'</span><span class="sy0">,</span> <span class="st_h">'NUL'</span><span class="sy0">,</span> <span class="st_h">'COM1'</span><span class="sy0">,</span> <span class="st_h">'COM2'</span><span class="sy0">,</span> <span class="st_h">'COM3'</span><span class="sy0">,</span> <span class="st_h">'COM4'</span><span class="sy0">,</span> 
	  <span class="st_h">'COM5'</span><span class="sy0">,</span> <span class="st_h">'COM6'</span><span class="sy0">,</span> <span class="st_h">'COM7'</span><span class="sy0">,</span> <span class="st_h">'COM8'</span><span class="sy0">,</span> <span class="st_h">'COM9'</span><span class="sy0">,</span> <span class="st_h">'LPT1'</span><span class="sy0">,</span> <span class="st_h">'LPT2'</span><span class="sy0">,</span> <span class="st_h">'LPT3'</span><span class="sy0">,</span> <span class="st_h">'LPT4'</span><span class="sy0">,</span> 
	  <span class="st_h">'LPT5'</span><span class="sy0">,</span> <span class="st_h">'LPT6'</span><span class="sy0">,</span> <span class="st_h">'LPT7'</span><span class="sy0">,</span> <span class="st_h">'LPT8'</span><span class="sy0">,</span> <span class="st_h">'LPT9'</span><span class="br0">&#41;</span><span class="sy0">;</span> 
&#160;
	<span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">in_array</span><span class="br0">&#40;</span><span class="kw3">strtoupper</span><span class="br0">&#40;</span><span class="re0">$s</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="re0">$_names</span><span class="sy0">,</span> <span class="kw4">true</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span>   
    <span class="br0">&#125;</span>
&#160;
    <span class="co2">## possible errors in UTF8-regular-expressions
</span>    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">empty</span><span class="br0">&#40;</span><span class="re0">$s</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span>
&#160;
    <span class="kw1">return</span> <span class="re0">$s</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></div></div></div>
</div>
<h3><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=24" title="Abschnitt bearbeiten: Scripte verhindern">Bearbeiten</a>]</span> <span class="mw-headline" id="Scripte_verhindern">Scripte verhindern</span></h3>
<p>Wenn das PHP-System als Modul im Apachen benutzt wird, sollte man für das per HTTP/s erreichbare Bilderverzeichnis den Parser ausschalten. Dies geht z.B. per Eintrag <b>in  der .htaccess-Datei</b> des Verzeinisses:
</p>
<pre>  'php_flag engine 0'
</pre>
<p>oder auch einem Eintrag in der passenden <b>Directory-Divison der Virtual-Host-Konfiguration</b>, was sicherer ist
</p>
<pre>  'php_admin_flag engine 0'      ## Überschreiben in der .htaccess-Datei ist verboten
</pre>
<p>oder 
</p>
<pre>  'php_flag engine 0'            ## Überschreiben in der .htaccess-Datei ist erlaubt 
</pre>
<p><br />
Hierdurch wäre dann die Interpretation und Ausführung von PHP-Dateien, die in dem betroffenen Verzeichnis liegen, unterdrückt.
</p><p>Eine zusätzliche Maßnahme, um die Ausführung von Scripten zu verhindern, ist die Wahl einer <i>ungefährlichen</i> Dateiendung. Wird PHP als Modul des Webservers eingesetzt, entscheiden die Dateiendungen darüber, ob abgerufene Ressourcen (hier Dateien) geparst werden, oder nicht. 
</p><p><b>Diese Einstellung ist aber von der Server-Konfiguration abhängig und könnte sich durch Eingriffe des Server-Administrators ändern!</b>
</p><p>Typischerweise werden z.B. Dateien mit den Endungen *.jpg, *.png, *.gif, *.bmp usw. nicht geparst. Bei der Verschiebung von Bildern kann man also die tatsächlich dafür vorgesehene Dateieindung aus einer <b>Positivliste</b> für die Zieldatei benutzten. Mehr darüber bei "Bilder erkennen".
</p><p>Es könnten aber auch andere Script-Interpreter aktiv sein, die man eventuell gar nicht benutzt. Bei Standardeinrichtungen sind auch Perl-Scripte vorgesehen. Den Fokus nur auf PHP zu richten, auch wenn man selbst nur mit PHP arbeitet, ist daher falsch.
</p>
<h2><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=25" title="Abschnitt bearbeiten: Sichern von Uploads">Bearbeiten</a>]</span> <span class="mw-headline" id="Sichern_von_Uploads"> Sichern von Uploads </span></h2>
<h3><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=26" title="Abschnitt bearbeiten: Konfigurationseinstellungen">Bearbeiten</a>]</span> <span class="mw-headline" id="Konfigurationseinstellungen">Konfigurationseinstellungen</span></h3>
<p>Auf den Upload von Massendaten wirken sich unterschiedliche Konfigurationseinstellungen (php.ini) aus:
</p>
<ul><li> Serverbeschränkungen (z.B. bei Apache <code>LimitRequestBody</code>, <a rel="nofollow" class="external text" href="http://httpd.apache.org/docs/2.2/mod/core.html#limitrequestbody">Handbuch</a>)
</li></ul>
<ul><li> <code>memory_limit</code> (<a rel="nofollow" class="external text" href="http://de3.php.net/manual/en/ini.core.php#ini.memory-limit">Handbuch</a>)
</li><li> <code>post_max_size</code> (<a rel="nofollow" class="external text" href="http://de3.php.net/manual/en/ini.core.php#ini.post-max-size">Handbuch</a>)
</li><li> <code>upload_max_filesize</code> (<a rel="nofollow" class="external text" href="http://de3.php.net/manual/en/ini.core.php#ini.upload-max-filesize">Handbuch</a>)
</li><li> <code>max_input_time</code> (<a rel="nofollow" class="external text" href="http://de3.php.net/manual/en/info.configuration.php#ini.max-input-time">Handbuch</a>)
</li><li> <code>file_uploads</code> (<a rel="nofollow" class="external text" href="http://de3.php.net/manual/en/ini.core.php#ini.file-uploads">Handbuch</a>)
</li></ul>
<p>Außerdem müssen (je nach verwendetem PHP-Interpretersystem: CGI, Fast-CGI, Modul) die Einstellungen stimmen für
</p>
<ul><li> <code>upload_tmp_dir</code> (<a rel="nofollow" class="external text" href="http://de3.php.net/manual/en/ini.core.php#ini.upload-tmp-dir">Handbuch</a>)
</li><li> <code>open_basedir</code> (<a rel="nofollow" class="external text" href="http://de3.php.net/manual/en/ini.core.php#ini.open-basedir">Handbuch</a>)
</li></ul>
<p><br />
</p>
<h3><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=27" title="Abschnitt bearbeiten: Kontrolliert speichern">Bearbeiten</a>]</span> <span class="mw-headline" id="Kontrolliert_speichern"> Kontrolliert speichern </span></h3>
<p>Eine rudimentäre Funktion, hochgeladene Daten nach den erfolgten notwendigen Tests aus dem Temporärverzeichnis an ihren persistenten Speicherort zu verschieben, stellt PHP mit
</p><p><code>move_uploaded_file()</code> zur Verfügung.
</p><p>Obwohl laut POSIX-Standard Streams bei Benutzung gesperrt werden müssen (advisory Lock), konnte ich dies bei dieser Funktion weder auf der Quellseite noch auf der Zielseite feststellen. Außerdem überschreibt die Funktion ohne Warnung bereits vorhandene Files. 
</p><p>Der eigentlich beabsichtigte Nutzen für diese Funktion, nämlich nur die von der eigenen Scriptinstanz als hochgeladen entgegengenommenen Dateien verschieben zu können, wird durch die Einführung von $_FILES auch obsolet. Der INHALT der "hochgeladenen" Datei wurde ohnehin nie abgesichert. Es wäre also immer noch möglich gewesen, den INHALT der Datei während der Zwischenspeicherung im Temporärverzeichnis durch eine Fremdinstanz zu verändern. Dies wird auch durch setzen des t-Flags im Dateisystem (Linux) nicht verhindert.
</p><p>Da PHP aber auch als Modul des Apachen die Möglichkeit bietet, jeder Domain (jeden VirtHost) ein eigenes Temporärverzeichnis zur Verfügung zu stellen, auf das (bei richtiger Einrichtung des Webservers) andere VirtHosts ("Domains") mittels PHP keinen Zugriff haben, ist das Problem der Veränderung des INHALTS durch PHP-Scripte beseitigt. Andere, parallel vorhandene Installationen mit anderen Sprachen sind hiermit aber leider noch nicht abgesichert!
</p><p>Durch Einführung von $_FILES mit den sicheren Elementen 
</p>
<ul><li> $_FILES[$inputname]['tmp_name'], 
</li><li> $_FILES[$inputname]['error'] und 
</li><li> $_FILES[$inputname]['size']
</li></ul>
<p>können wir uns nun selber eine sichere Funktion erstellen, die sowohl auf der Quellseite, als auch auf der Zielseite "weiß, was sie tut", also das atomistische Modell einhält und uns kein TOCTTOU-Problem baut. Siehe auch <a rel="nofollow" class="external free" href="https://de.wikipedia.org/wiki/Time-of-Check-to-Time-of-Use-Problem">https://de.wikipedia.org/wiki/Time-of-Check-to-Time-of-Use-Problem</a>.
</p><p>Wir haben also mehrere Freiheitsgrade:
</p>
<ul><li> Datei auf der Quellseite ist nicht vorhanden -&gt; Abbruch
</li><li> Datei auf der Quellseite ist vorhanden -&gt; Öffnen und zum Lesen sperren
</li><li> Datei auf der Zielseite soll vorhanden sein und soll überschrieben werden -&gt; öffnen, sperren, überschreiben, kürzen
</li><li> Datei auf der Zielseite darf nicht vorhanden sein und muss neu angelegt werden -&gt; anlegen, sperren, beschreiben
</li><li> Datei auf der Zielseite soll auf jeden Fall geschrieben werden -&gt; Neu anlegen oder öffnen, sperren, beschreiben/überschreiben
</li></ul>
<p>Diese Liste und ihre Umsetzung ist jeweils abhängig vom Filesystem und der Verwendeten Programmiersprache, in der die Funktionen auf die API zugreifen. Das muss uns hier im Moment aber nicht weiter interessieren.
</p>
<div class="note-box note-box-example vorlage_beispiel">
<div class="note-box-title">Beispiel
</div>
<div class="note-box-text note-box-example-code"><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="php source-php"><pre class="de1"><span class="co2">#---- Error Codes ---Samples------
</span><span class="co2">#  0: No Error
</span><span class="co2">#---- Low Level Errors -----------
</span><span class="co2">#  1:
</span><span class="co2">#  2: File not Found
</span><span class="co2">#  3: File already exists
</span><span class="co2">#  4: Could not read file, no data
</span><span class="co2">#  5: Could not open file
</span><span class="co2">#  6: Could not lock file 
</span><span class="co2">#  7:
</span><span class="co2">#---- Data Errors ----------------
</span><span class="co2"># 11: No valid data 
</span><span class="co2"># 12: No valid Attribs
</span><span class="co2"># 99: unknown Error</span></pre></div></div></div>
</div>
<p><br />
</p>
<div class="note-box note-box-example vorlage_beispiel">
<div class="note-box-title">Beispiel
</div>
<div class="note-box-text note-box-example-code"><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="php source-php"><pre class="de1"><span class="kw2">function</span> save_uploaded_file<span class="br0">&#40;</span><span class="re0">$source</span><span class="sy0">,</span> <span class="re0">$target</span><span class="sy0">,</span> <span class="re0">$overwrite</span><span class="sy0">=</span><span class="nu0">0</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="co2"># $overwrite == 0 -&gt; no overwrite, only create if not exists
</span>    <span class="co2"># $overwrite == 1 -&gt; open only if exists, overwrite, truncate!
</span>    <span class="co2"># $overwrite == 2 -&gt; rewrite existing or create new
</span>
    <span class="co2"># we believe that php will not produce 'lost handles' if we leave 
</span>    <span class="co2"># this function without closing them.
</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">is_int</span><span class="br0">&#40;</span><span class="re0">$overwrite</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="nu0">12</span><span class="sy0">;</span>
&#160;
    <span class="co2"># open source
</span>    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$fs</span> <span class="sy0">=</span> <span class="kw3">fopen</span><span class="br0">&#40;</span><span class="re0">$source</span><span class="sy0">,</span> <span class="st_h">'rb'</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="nu0">5</span><span class="sy0">;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">flock</span><span class="br0">&#40;</span><span class="re0">$fs</span><span class="sy0">,</span> LOCK_SH<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="nu0">6</span><span class="sy0">;</span> <span class="co2">## Source could not be locked;
</span>
    <span class="co2"># open target
</span>
    <span class="kw1">switch</span> <span class="br0">&#40;</span><span class="re0">$overwrite</span><span class="br0">&#41;</span> 
    <span class="br0">&#123;</span>
        <span class="kw1">case</span> <span class="nu0">0</span><span class="sy0">:</span>  
            <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$ft</span> <span class="sy0">=</span> <span class="kw3">fopen</span><span class="br0">&#40;</span><span class="re0">$target</span><span class="sy0">,</span> <span class="st_h">'xb'</span><span class="br0">&#41;</span><span class="br0">&#41;</span>  <span class="kw1">return</span> <span class="nu0">3</span><span class="sy0">;</span>  <span class="co2">## assumed 'already exists'
</span>        <span class="kw1">break</span><span class="sy0">;</span>
&#160;
        <span class="kw1">case</span> <span class="nu0">1</span><span class="sy0">:</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$ft</span> <span class="sy0">=</span> <span class="kw3">fopen</span><span class="br0">&#40;</span><span class="re0">$target</span><span class="sy0">,</span> <span class="st_h">'rb+'</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="nu0">2</span><span class="sy0">;</span>  <span class="co2">## assumed 'not found'
</span>        <span class="kw1">break</span><span class="sy0">;</span>
&#160;
        <span class="kw1">case</span> <span class="nu0">2</span><span class="sy0">:</span>
            <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$ft</span> <span class="sy0">=</span> <span class="kw3">fopen</span><span class="br0">&#40;</span><span class="re0">$target</span><span class="sy0">,</span> <span class="st_h">'wb'</span><span class="br0">&#41;</span><span class="br0">&#41;</span>  <span class="kw1">return</span> <span class="nu0">5</span><span class="sy0">;</span>  <span class="co2">## assumed 'could not open'
</span>        <span class="kw1">break</span><span class="sy0">;</span>
&#160;
        <span class="kw1">default</span><span class="sy0">:</span>
            <span class="kw1">return</span> <span class="nu0">12</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&#160;
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">flock</span><span class="br0">&#40;</span><span class="re0">$ft</span><span class="sy0">,</span> LOCK_EX<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="nu0">6</span><span class="sy0">;</span>          <span class="co2">## Target could not be locked;
</span>
    <span class="re0">$filesize</span> <span class="sy0">=</span> <span class="kw3">filesize</span><span class="br0">&#40;</span><span class="re0">$source</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="re0">$cont</span> <span class="sy0">=</span> <span class="kw3">fread</span><span class="br0">&#40;</span><span class="re0">$fs</span><span class="sy0">,</span> <span class="re0">$filesize</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">strlen</span><span class="br0">&#40;</span><span class="re0">$cont</span><span class="br0">&#41;</span> <span class="sy0">!=</span> <span class="re0">$filesize</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="nu0">4</span><span class="sy0">;</span>    
&#160;
    <span class="kw3">fwrite</span><span class="br0">&#40;</span><span class="re0">$ft</span><span class="sy0">,</span> <span class="re0">$cont</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
    <span class="kw3">fclose</span><span class="br0">&#40;</span><span class="re0">$fs</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
    <span class="co2">## new file perhaps is shorter than old one
</span>    <span class="kw3">ftruncate</span><span class="br0">&#40;</span><span class="re0">$ft</span><span class="sy0">,</span> <span class="re0">$filesize</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw3">fclose</span><span class="br0">&#40;</span><span class="re0">$ft</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
    <span class="kw1">return</span> <span class="nu0">0</span><span class="sy0">;</span>
&#160;
<span class="br0">&#125;</span></pre></div></div></div>
</div>
<h2><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=28" title="Abschnitt bearbeiten: Dateien bereitstellen">Bearbeiten</a>]</span> <span class="mw-headline" id="Dateien_bereitstellen">Dateien bereitstellen</span></h2>
<h3><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=29" title="Abschnitt bearbeiten: innerhalb der Document Root">Bearbeiten</a>]</span> <span class="mw-headline" id="innerhalb_der_Document_Root">innerhalb der Document Root</span></h3>
<h4><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=30" title="Abschnitt bearbeiten: Script-Ausführung abschalten">Bearbeiten</a>]</span> <span class="mw-headline" id="Script-Ausf.C3.BChrung_abschalten">Script-Ausführung abschalten</span></h4>
<p>Wenn keine andere Möglichkeit besteht, oder man es sich "einfach" machen will (z. B. für öffentliche Bilderverzeichnisse), dann speichert man die hochgeladenen Dateien i.d.R. in einem Verzeichnis, das innerhalb der Document-Root liegt. Das führt dann normalerweise auch dazu, dass diverse Dateien (Dateiendungen) zur Ausführung (Interpretation) der hochgeladenen Datei führen, wenn diese per http/s aufgerufen wird.
</p><p>Um zumindest zu verhindern, dass PHP-Dateien in diesem Verzeichnis ausgeführt werden können. sollte man unbedingt den Parser für dieses Verzeichnis abschalten
</p>
<div class="note-box note-box-example vorlage_beispiel">
<div class="note-box-title">Beispiel
</div>
<div class="note-box-text note-box-example-code"><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="apache source-apache"><pre class="de1"><span class="co1"># .htaccess </span>
&#160;
<span class="kw1">php_value</span> engine <span class="nu0">0</span>
&#160;
<span class="co1"># end of .htaccess</span></pre></div></div></div>
</div>
<p>Dass die .htaccess-Datei nun besonders geschützt sein muss, also sicherheitshalber nur durch root beschreibbar sein darf, versteht sich hoffentlich von selbst.
</p><p>Besser ist es ohnehin, diese Einstellung in den VirtHost-Konfiguration oder der httpd.conf vorzunehmen, dort dann auch am besten als Admin-User
</p><p><b>php_admin_value engine 0</b>
</p>
<h4><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=31" title="Abschnitt bearbeiten: Hochladen schädlicher Dateien unterbinden">Bearbeiten</a>]</span> <span class="mw-headline" id="Hochladen_sch.C3.A4dlicher_Dateien_unterbinden">Hochladen schädlicher Dateien unterbinden</span></h4>
<p>Im Sicherheitskonzept der "Uploadspezialisten", auch in etablierten CMS, wird immer gerne vergessen, dass es außer ausführbaren Dateien auch eine nichtausführbare gibt, mit der man sehr viel Schaden anrichten kann.
</p><p>die Datei <b>.htaccess</b>   [Die Bezeichnung ist außerdem abhängig von den Servereinstellungen]
</p><p>Gelingt es einem Client, eine eigene .htaccess auf einem Apache-Webserver innerhalb der Document-Root zu plazieren, kann er damit meistens den Server übernehmen.
</p>
<h3><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=32" title="Abschnitt bearbeiten: außerhalb der Document Root">Bearbeiten</a>]</span> <span class="mw-headline" id="au.C3.9Ferhalb_der_Document_Root">außerhalb der Document Root</span></h3>
<p>siehe vorerst "hochgeladene Inhalte bereitstellen"
</p>
<h3><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=33" title="Abschnitt bearbeiten: in Datenbanken speichern">Bearbeiten</a>]</span> <span class="mw-headline" id="in_Datenbanken_speichern">in Datenbanken speichern</span></h3>
<h2><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=34" title="Abschnitt bearbeiten: Typische Sicherheitslücken">Bearbeiten</a>]</span> <span class="mw-headline" id="Typische_Sicherheitsl.C3.BCcken">Typische Sicherheitslücken</span></h2>
<div class="note-box note-box-todo"><p class="note-box-title">ToDo:&#160;&#160;&#160;&#160;<span class="note-box-more small">(<a href="http://wiki.selfhtml.org/wiki/Kategorie:ToDo" title="Kategorie:ToDo"><span style="color:#eef;text-decoration:underline">weitere ToDos</span></a>)</span></p><div class="note-box-text">
<p>[Übersicht über die üblichen Sicherheitslücken]
</p>
</div></div>
<h2><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=35" title="Abschnitt bearbeiten: Workflow">Bearbeiten</a>]</span> <span class="mw-headline" id="Workflow">Workflow</span></h2>
<h3><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=36" title="Abschnitt bearbeiten: Schritt für Schritt zum Ziel">Bearbeiten</a>]</span> <span class="mw-headline" id="Schritt_f.C3.BCr_Schritt_zum_Ziel">Schritt für Schritt zum Ziel</span></h3>
<ul><li> Testserver in der DMZ (LAN) einrichten
</li><li> VirtHost einrichten
</li><li> Verzeichnisse laut Abschnitt <b>Verzeichnisstruktur</b> einrichten 
</li><li> Einstellungen in den Servereinstellungen und den VirtHosts anpassen, 
</li></ul>
<pre> Server neu starten und testen
</pre>
<ul><li> Formular in HTML erstellen für den Client
</li><li> Testscript in PHP erstellen, mit dem <code>$_FILES</code> ausgewertet wird
</li><li> Kontrollen durchführen
</li><li> Script (Funktionen) erstellen für den Upload
</li><li> Uploaded File nach allen Regeln der Kunst auf schädliche Inhalte prüfen
</li><li> Uploaded File sicher ins zutreffende Repository übertragen und ggf. den zugehörigen Eintrag in der Datenbank erstellen
</li><li> Dem User eine aussagefähige Quittung senden
</li></ul>
<ul><li> Zugriffsrechte regeln
</li><li> Download-Angebote bereitstellen (unter Berücksichtigung der jeweiligen User-Rechte)
</li><li> Sicherheitslücken suchen, Grenzen ermitteln
</li></ul>
<ul><li> Webangebot aus der DMZ auf den Produktivserver übertragen
</li><li> Testen, testen, testen
</li></ul>
<h3><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=37" title="Abschnitt bearbeiten: Dialog-Elemente und File-Upload kombinieren">Bearbeiten</a>]</span> <span class="mw-headline" id="Dialog-Elemente_und_File-Upload_kombinieren">Dialog-Elemente und File-Upload kombinieren</span></h3>
<p>In einem Formular können sich diverse unterschiedliche Elemente und Input-Elemente diverser Typen befinden:
</p>
<ul><li> Text
</li><li> Select
</li><li> Radio
</li><li> Hidden
</li><li> Textarea
</li></ul>
<p>.
</p>
<ul><li> File
</li></ul>
<p><br />
Es ist meistens nicht sinnvoll, die Elemente vom Typ File sofort zusammen mit den textbasierten Elementen zu übertragen. Elemente vom Typ File haben meistens ein großes Transfervolumen und außerdem müssen sie zugeordnet werden können. Wenn die Zuordnung aber erst durch die ggf. fehlerhaften textbasierten Elemente stattfinden kann, hängen die Files auf dem Server "in der Luft". Wenn die Request-Abarbeitung  endet, gehen sie üblicherweise wieder verloren und müssten jedes Mal erneut übertragen werden.
</p><p>Eine mehrstufige Übertragung ist daher sinnvoll. Zuerst werden die textbasierten Elemente übertragen und solange geprüft, bis sie akzeptiert werden können und erst dann werden durch das Form die File-Elemente zum Upload angefordert.
</p><p><br />
</p>
<div class="note-box note-box-todo"><p class="note-box-title">ToDo:&#160;&#160;&#160;&#160;<span class="note-box-more small">(<a href="http://wiki.selfhtml.org/wiki/Kategorie:ToDo" title="Kategorie:ToDo"><span style="color:#eef;text-decoration:underline">weitere ToDos</span></a>)</span></p><div class="note-box-text">
<p>[Mehrstufiges Affenformular mit history.back()-Sperre]
</p><p>Fileupload wird erst freigegeben, wenn die einfachen Textfelder akzeptiert werden konnten
</p>
<ul><li> Arbeiten mit serialized Forwards
</li><li> Arbeiten mit Sessions
</li><li> Einsatz von <code>header</code>
</li></ul>
</div></div>
<h3><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=38" title="Abschnitt bearbeiten: Sessions nutzen für den File-Upload">Bearbeiten</a>]</span> <span class="mw-headline" id="Sessions_nutzen_f.C3.BCr_den_File-Upload">Sessions nutzen für den File-Upload</span></h3>
<h3><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=39" title="Abschnitt bearbeiten: Multiupload per JavaScript unterstützen">Bearbeiten</a>]</span> <span class="mw-headline" id="Multiupload_per_JavaScript_unterst.C3.BCtzen">Multiupload per JavaScript unterstützen</span></h3>
<h2><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=40" title="Abschnitt bearbeiten: Hochgeladene Inhalte gesichert bereitstellen">Bearbeiten</a>]</span> <span class="mw-headline" id="Hochgeladene_Inhalte_gesichert_bereitstellen">Hochgeladene Inhalte gesichert bereitstellen</span></h2>
<h3><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=41" title="Abschnitt bearbeiten: URL-Parameter contra URL-Rewriting (mod rewrite)">Bearbeiten</a>]</span> <span class="mw-headline" id="URL-Parameter_contra_URL-Rewriting_.28mod_rewrite.29">URL-Parameter contra URL-Rewriting (mod_rewrite)</span></h3>
<h3><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=42" title="Abschnitt bearbeiten: Bilder ausliefern per Script">Bearbeiten</a>]</span> <span class="mw-headline" id="Bilder_ausliefern_per_Script">Bilder ausliefern per Script</span></h3>
<p>Wir haben bereits erwähnt, dass es eine Methode sein kann, hochgeladene Bilder oder Inhalte eines Users vor dem Zugriff anderer User zu schützen, in dem man sie auf dem Web-Host in einem Verzeichnis speichert, das nicht direkt per HTTP/s zugänglich ist. Damit kann der Browser des entfernten Client nicht ungeprüft (per HTTP/s) auf die Ressource zugreifen.
</p><p>Um die Bilder trotzdem ausliefern zu können, benötigt man dann ein Script. Dessen URi wird im Frontend ganz einfach dort, wo sonst die URL auf das Bild eingebunden wird, eingebunden. 
</p><p>Bevor nun das Bild mit der Funktion ausgegeben wird, muss jetzt das Programm (Script) prüfen, ob der User berechtigt ist, die angeforderte Ressource zu erhalten. Dies geht am besten per internem Check auf "Login/User-ID" und Verwendung einer Datenbanktabelle.
</p><p><br />
</p>
<div class="note-box note-box-example vorlage_beispiel">
<div class="note-box-title">Beispiel
</div>
<div class="note-box-text note-box-example-code"><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="php source-php"><pre class="de1"><span class="co2">## Zugehörige Konstanten ##
</span><span class="kw3">define</span> <span class="br0">&#40;</span><span class="st_h">'CACHE_MUST_REVALIDATE'</span><span class="sy0">,</span> <span class="nu0">604800</span><span class="br0">&#41;</span><span class="sy0">;</span>   <span class="co2">## Zeit, nach der der Cache die Verifikation betreiben soll</span></pre></div></div></div>
</div>
<p>Funktion für die Image-Response:
</p>
<div class="note-box note-box-example vorlage_beispiel">
<div class="note-box-title">Beispiel
</div>
<div class="note-box-text note-box-example-code"><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="php source-php"><pre class="de1"><span class="kw2">function</span> put_image<span class="br0">&#40;</span><span class="re0">$filename</span><span class="sy0">,</span> <span class="re0">$aliasname</span> <span class="sy0">=</span> <span class="kw4">false</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="co2">#@filename    String   Pfad zur Datei im lokalen Dateisystem
</span>    <span class="co2">#@aliasname   String   Name, der vom Client zum Speichern vorgeschlagen werden soll
</span>    <span class="co2">#                      wenn er angebeben wurde, wird der Name mit übertragen
</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">headers_sent</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span>
&#160;
    <span class="re0">$fh</span> <span class="sy0">=</span> <span class="sy0">@</span><span class="kw3">fopen</span><span class="br0">&#40;</span><span class="re0">$filename</span><span class="sy0">,</span><span class="st0">&quot;rb&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>  
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$fh</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span>
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="kw3">flock</span><span class="br0">&#40;</span><span class="re0">$fh</span><span class="sy0">,</span> LOCK_SH<span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span> 
&#160;
    <span class="co2">### prüfen, ob das Bild im Server neuer ist als im Cache des Browsers ###
</span>    <span class="re0">$last_modified</span> <span class="sy0">=</span> <span class="sy0">@</span><span class="kw3">gmdate</span><span class="br0">&#40;</span><span class="st_h">'D, d M Y H:i:s'</span><span class="sy0">,@</span><span class="kw3">filemtime</span><span class="br0">&#40;</span><span class="re0">$filename</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">.</span><span class="st_h">' GMT'</span><span class="sy0">;</span>
&#160;
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st_h">'HTTP_IF_MODIFIED_SINCE'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> 
    <span class="br0">&#123;</span>
        <span class="co1">// parse header</span>
        <span class="re0">$if_modified_since</span> <span class="sy0">=</span> <span class="kw3">preg_replace</span><span class="br0">&#40;</span><span class="st_h">'/;.*$/'</span><span class="sy0">,</span> <span class="st_h">''</span><span class="sy0">,</span> <span class="re0">$_SERVER</span><span class="br0">&#91;</span><span class="st_h">'HTTP_IF_MODIFIED_SINCE'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="re0">$if_modified_since</span> <span class="sy0">==</span> <span class="re0">$last_modified</span><span class="br0">&#41;</span> 
        <span class="br0">&#123;</span>
            <span class="co1">// the browser's cache is still up to date</span>
            <span class="kw3">header</span><span class="br0">&#40;</span><span class="st0">&quot;HTTP/1.0 304 Not Modified&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw3">header</span><span class="br0">&#40;</span><span class="st0">&quot;Cache-Control: max-age=&quot;</span> <span class="sy0">.</span> CACHE_MUST_REVALIDATE <span class="sy0">.</span> <span class="st0">&quot;, must-revalidate&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw3">fclose</span><span class="br0">&#40;</span><span class="re0">$fh</span><span class="br0">&#41;</span><span class="sy0">;</span>
            <span class="kw1">return</span> <span class="kw4">true</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>   
    <span class="br0">&#125;</span>
&#160;
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$_imgsize</span> <span class="sy0">=</span> <span class="sy0">@</span><span class="kw3">getimagesize</span><span class="br0">&#40;</span><span class="re0">$filename</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="kw3">fclose</span><span class="br0">&#40;</span><span class="re0">$fh</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>   
&#160;
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw3">isset</span><span class="br0">&#40;</span><span class="re0">$_imgsize</span><span class="br0">&#91;</span><span class="st_h">'mime'</span><span class="br0">&#93;</span><span class="br0">&#41;</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>   
        <span class="kw3">header</span> <span class="br0">&#40;</span><span class="st0">&quot;Last-Modified: <span class="es4">$last_modified</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span> 
        <span class="kw3">header</span><span class="br0">&#40;</span><span class="st0">&quot;Content-type: <span class="es4">{$_imgsize['mime']}</span>&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&#160;
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="kw4">false</span> <span class="sy0">!==</span> <span class="re0">$aliasname</span><span class="br0">&#41;</span>
	<span class="br0">&#123;</span>
	    <span class="kw3">header</span><span class="br0">&#40;</span><span class="st_h">'Content-Disposition: inline; filename=&quot;'</span> <span class="sy0">.</span> <span class="re0">$aliasname</span> <span class="sy0">.</span> <span class="st_h">'&quot;'</span><span class="br0">&#41;</span><span class="sy0">;</span>
	<span class="br0">&#125;</span>	
&#160;
        <span class="kw3">fpassthru</span><span class="br0">&#40;</span><span class="re0">$fh</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw3">fclose</span><span class="br0">&#40;</span><span class="re0">$fh</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="kw1">return</span> <span class="kw4">true</span><span class="sy0">;</span> 
    <span class="br0">&#125;</span>
&#160;
    <span class="kw3">fclose</span><span class="br0">&#40;</span><span class="re0">$fh</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="kw1">return</span> <span class="kw4">false</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre></div></div></div>
</div>
<p>Man muss darauf achten, dass das Script, in dem diese Funktion benutzt wird, keinerlei weitere Ausgaben vornimmt, wenn das Bild erfolgreich ausgegeben werden konnte. 
</p><p><br />
Das Script für den Einsatz z. B. im &lt;img&gt;-Element kann nach dem folgenden Muster aufgebaut werden:
</p>
<div class="note-box note-box-example vorlage_beispiel">
<div class="note-box-title">Beispiel
</div>
<div class="note-box-text note-box-example-code"><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="php source-php"><pre class="de1"><span class="kw2">&lt;?php</span>  <span class="co2">### getimg.php ### Bild aus dem Filesystem ausliefern ### utf-8 ### ÄÖÜäöü
</span>    
    <span class="co2">## GET-Parameter mit Bild-Nummer vorhanden?
</span>    
    <span class="co2">## Benutzer angemeldet?
</span>
    <span class="co2">## Datenbankverbindung vorhanden?
</span>
    <span class="co2">## Abfrage: Darf der User dieses Bild sehen?
</span>    <span class="co2">##          wie heißt das Bild mit Trivialnamen?
</span>
    <span class="co2">##-&gt; Ja: Bild ausliefern mit put_image()
</span>    <span class="co2">##-&gt; Nein: Ersatzbild ausliefern
</span>
    <span class="kw3">exit</span> <span class="br0">&#40;</span><span class="nu0">0</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="sy1">?&gt;</span></pre></div></div></div>
</div>
<p>Das fertige Script speichern wir dann in der Document-Root.
</p><p><br />
Im HTML-Code wird das dann einfach genauso, wie eine Bild-URL eingebunden:
</p>
<div class="note-box note-box-example vorlage_beispiel">
<div class="note-box-title">Beispiel
</div>
<div class="note-box-text note-box-example-code"><div dir="ltr" class="mw-geshi mw-code mw-content-ltr"><div class="html5 source-html5"><pre class="de1">    <span class="sc2">&lt;<span class="kw2">img</span> <span class="kw3">class</span><span class="sy0">=</span><span class="st0">&quot;mystyle&quot;</span> <span class="kw3">src</span><span class="sy0">=</span><span class="st0">&quot;/getimg.php?n=101356&quot;</span> <span class="kw3">alt</span><span class="sy0">=</span><span class="st0">&quot;Bild vom Geburtstag&quot;</span> <span class="kw3">title</span><span class="sy0">=</span><span class="st0">&quot;3 x 0 = 30&quot;</span>&gt;</span></pre></div></div></div>
</div>
<p>Wie wir sehen, können sowohl im ALT-Attribut als auch im TITLE-Attribut bereits sensible Daten stehen. Daher sollte 
in einem CMS dem Client der gesamte Image-Tag gar nicht erst angeboten werden, wenn der Client keine Rechte auf das Source-Objekt und dessen Beschreibung hat.
</p><p>Trotzdem muss der Request <code>/getimg.php?n=101356</code> separat abgesichert bleiben, da er auch diskret (also ohne das CMS) ausgeführt werden kann!
</p>
<h3><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=43" title="Abschnitt bearbeiten: Files bereitstellen per Script">Bearbeiten</a>]</span> <span class="mw-headline" id="Files_bereitstellen_per_Script"> Files bereitstellen per Script </span></h3>
<p>Dass man einem Skript per URL-Parametern mitteilen kann, welche Ressourcen es heranziehen soll für die Beantwortung der Anfrage, haben wir im letzten Kapitel gesehen. Wäre aber nach außen nicht viel schöner, den direkten Aufruf einer Ressource mi einem sprechenden Bezeichner zu benutzen und trotzdem das Skript zur Kontrolle des Requests zwischengeschaltet zu haben?
</p><p>[Beispiel mit URL-Parametern]
</p><p>[Beispiel mit sprechendem Ressoource-Path]
</p><p>Wie funktioniert das?
</p>
<h3><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=44" title="Abschnitt bearbeiten: Unkontrollierter Zugriff">Bearbeiten</a>]</span> <span class="mw-headline" id="Unkontrollierter_Zugriff">Unkontrollierter Zugriff</span></h3>
<h3><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=45" title="Abschnitt bearbeiten: Bedingter Zugriff">Bearbeiten</a>]</span> <span class="mw-headline" id="Bedingter_Zugriff">Bedingter Zugriff</span></h3>
<h3><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=46" title="Abschnitt bearbeiten: Bedingter Zugriff mit spezifischen Benutzerrechten">Bearbeiten</a>]</span> <span class="mw-headline" id="Bedingter_Zugriff_mit_spezifischen_Benutzerrechten">Bedingter Zugriff mit spezifischen Benutzerrechten</span></h3>
<h3><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=47" title="Abschnitt bearbeiten: Kontrolle per Sessiondaten contra Datenbankabfrage">Bearbeiten</a>]</span> <span class="mw-headline" id="Kontrolle_per_Sessiondaten_contra_Datenbankabfrage">Kontrolle per Sessiondaten contra Datenbankabfrage</span></h3>
<p>... to be written
Das will ich gerne übernehmen, denn das habe ich gerade durchexerziert
</p><p>Robert Roth --93.195.228.97 10:04, 20. Dez. 2014 (CET)
</p>
<h3><span class="editsection">[<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit&amp;section=48" title="Abschnitt bearbeiten: Large Objects aus der Datenbank bereitstellen">Bearbeiten</a>]</span> <span class="mw-headline" id="Large_Objects_aus_der_Datenbank_bereitstellen">Large Objects aus der Datenbank bereitstellen</span></h3>
<p>... to be written
</p><p>.
</p>
<!-- 
NewPP limit report
Preprocessor node count: 1284/1000000
Post‐expand include size: 19849/2097152 bytes
Template argument size: 13948/2097152 bytes
Expensive parser function count: 0/100
ExtLoops count: 0/100
-->

<!-- Saved in parser cache with key webwiki:pcache:idhash:761-0!*!0!!de-formal!2!* and timestamp 20150301150416 -->
</div>				<!-- /bodycontent -->
								<!-- printfooter -->
				<div class="printfooter">
				Von „<a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;oldid=24607">http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;oldid=24607</a>“				</div>
				<!-- /printfooter -->
												<!-- catlinks -->
				<div id='catlinks' class='catlinks'><div id="mw-normal-catlinks" class="mw-normal-catlinks"><a href="http://wiki.selfhtml.org/wiki/Spezial:Kategorien" title="Spezial:Kategorien">Kategorien</a>: <ul><li><a href="http://wiki.selfhtml.org/wiki/Kategorie:ToDo" title="Kategorie:ToDo">ToDo</a></li><li><a href="http://wiki.selfhtml.org/wiki/Kategorie:PHP" title="Kategorie:PHP">PHP</a></li></ul></div></div>				<!-- /catlinks -->
												<div class="visualClear"></div>
				<!-- debughtml -->
								<!-- /debughtml -->
			</div>
			<!-- /bodyContent -->
		</div>
		<!-- /content -->
		<!-- header -->
		<div id="mw-head" class="noprint">
			
<!-- 0 -->
<div id="p-personal" class="">
	<h5>Meine Werkzeuge</h5>
	<ul>
		<li id="pt-anonuserpage"><a href="http://wiki.selfhtml.org/wiki/Benutzer:178.203.200.214" class="new" title="Benutzerseite der IP-Adresse, von der aus Sie Änderungen durchführen [.]" accesskey=".">178.203.200.214</a></li>
		<li id="pt-anontalk"><a href="http://wiki.selfhtml.org/wiki/Benutzer_Diskussion:178.203.200.214" class="new" title="Diskussion über Änderungen von dieser IP-Adresse [n]" accesskey="n">Diskussionsseite dieser IP</a></li>
		<li id="pt-anonlogin"><a href="http://wiki.selfhtml.org/index.php?title=Spezial:Anmelden&amp;returnto=PHP%2FAnwendung+und+Praxis%2FFile+Upload" title="Sich anzumelden wird zwar gerne gesehen, ist aber keine Pflicht. [o]" accesskey="o">Anmelden / Benutzerkonto erstellen</a></li>
	</ul>
</div>

<!-- /0 -->
			<div id="left-navigation">
				
<!-- 0 -->
<div id="p-namespaces" class="vectorTabs">
	<h5>Namensräume</h5>
	<ul>
					<li  id="ca-nstab-main" class="selected"><span><a href="http://wiki.selfhtml.org/wiki/PHP/Anwendung_und_Praxis/File_Upload"  title="Seiteninhalt anzeigen [c]" accesskey="c">Seite</a></span></li>
					<li  id="ca-talk"><span><a href="http://wiki.selfhtml.org/wiki/Diskussion:PHP/Anwendung_und_Praxis/File_Upload"  title="Diskussion zum Seiteninhalt [t]" accesskey="t">Diskussion</a></span></li>
			</ul>
</div>

<!-- /0 -->

<!-- 1 -->
<div id="p-variants" class="vectorMenu emptyPortlet">
	<h4>
		</h4>
	<h5><span>Varianten</span><a href="#"></a></h5>
	<div class="menu">
		<ul>
					</ul>
	</div>
</div>

<!-- /1 -->
			</div>
			<div id="right-navigation">
				
<!-- 0 -->
<div id="p-views" class="vectorTabs">
	<h5>Ansichten</h5>
	<ul>
					<li id="ca-view" class="selected"><span><a href="http://wiki.selfhtml.org/wiki/PHP/Anwendung_und_Praxis/File_Upload" >Lesen</a></span></li>
					<li id="ca-edit"><span><a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=edit"  title="Seite bearbeiten. Bitte vor dem Speichern die Vorschaufunktion benutzen. [e]" accesskey="e">Bearbeiten</a></span></li>
					<li id="ca-history" class="collapsible"><span><a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;action=history"  title="Frühere Versionen dieser Seite [h]" accesskey="h">Versionsgeschichte</a></span></li>
			</ul>
</div>

<!-- /0 -->

<!-- 1 -->
<div id="p-cactions" class="vectorMenu emptyPortlet">
	<h5><span>Aktionen</span><a href="#"></a></h5>
	<div class="menu">
		<ul>
					</ul>
	</div>
</div>

<!-- /1 -->

<!-- 2 -->
<div id="p-search">
	<h5><label for="searchInput">Suche</label></h5>
	<form action="http://wiki.selfhtml.org/index.php" id="searchform">
				<div>
			<input type="search" name="search" title="SELFHTML-Wiki durchsuchen [f]" accesskey="f" id="searchInput" />			<input type="submit" name="go" value="Seite" title="Gehe direkt zu der Seite, die exakt dem eingegebenen Namen entspricht." id="searchGoButton" class="searchButton" />			<input type="submit" name="fulltext" value="Suchen" title="Suche nach Seiten, die diesen Text enthalten" id="mw-searchButton" class="searchButton" />					<input type='hidden' name="title" value="Spezial:Suche"/>
		</div>
	</form>
</div>

<!-- /2 -->
			</div>
		</div>
		<!-- /header -->
		<!-- panel -->
			<div id="mw-panel" class="noprint">
				<!-- logo -->
					<div id="p-logo"><a style="background-image: url(http://src.selfhtml.org/logo/S-110.png);" href="http://wiki.selfhtml.org/wiki/Startseite"  title="Startseite"></a></div>
				<!-- /logo -->
				
<!-- Übersicht -->
<div class="portal" id='p-.C3.9Cbersicht'>
	<h5>Übersicht</h5>
	<div class="body">
		<ul>
			<li id="n-mainpage-description"><a href="http://wiki.selfhtml.org/wiki/Startseite" title="Startseite besuchen [z]" accesskey="z">Startseite</a></li>
			<li id="n-Mitmachen.21"><a href="http://wiki.selfhtml.org/wiki/SELFHTML:Über">Mitmachen!</a></li>
			<li id="n-Referenz"><a href="http://wiki.selfhtml.org/wiki/Referenzen" title="der schnelle Überblick für erfahrene Anwender">Referenz</a></li>
			<li id="n-Glossar"><a href="http://wiki.selfhtml.org/wiki/Glossar" title="kürzeste Erläuterungen zu Fachbegriffen">Glossar</a></li>
		</ul>
	</div>
</div>

<!-- /Übersicht -->

<!-- Hilfe -->
<div class="portal" id='p-Hilfe'>
	<h5>Hilfe</h5>
	<div class="body">
		<ul>
			<li id="n-Hilfe"><a href="http://wiki.selfhtml.org/wiki/Hilfe">Hilfe</a></li>
		</ul>
	</div>
</div>

<!-- /Hilfe -->

<!-- SELFHTML -->
<div class="portal" id='p-SELFHTML'>
	<h5>SELFHTML</h5>
	<div class="body">
		<ul>
			<li id="n-SELFHTML"><a href="http://selfhtml.org/" rel="nofollow">SELFHTML</a></li>
			<li id="n-Doku"><a href="http://wiki.selfhtml.org/wiki/Startseite">Doku</a></li>
			<li id="n-Forum"><a href="http://forum.de.selfhtml.org/" rel="nofollow">Forum</a></li>
			<li id="n-Blog"><a href="http://blog.selfhtml.org/" rel="nofollow">Blog</a></li>
		</ul>
	</div>
</div>

<!-- /SELFHTML -->

<!-- Diverses -->
<div class="portal" id='p-Diverses'>
	<h5>Diverses</h5>
	<div class="body">
		<ul>
			<li id="n-SELFHTML-e.V."><a href="http://wiki.selfhtml.org/wiki/SELFHTML" title="Informationen zum Verein SELFHTML e.V.">SELFHTML e.V.</a></li>
			<li id="n-Archiv-kompakt"><a href="http://wiki.selfhtml.org/wiki/Archiv_kompakt" title="fachlich wertvolle Diskussionen aus dem SELFHTML-Forum">Archiv kompakt</a></li>
			<li id="n-recentchanges"><a href="http://wiki.selfhtml.org/wiki/Spezial:Letzte_Änderungen" title="Liste der letzten Änderungen in SELFHTML-Wiki [r]" accesskey="r">Letzte Änderungen</a></li>
		</ul>
	</div>
</div>

<!-- /Diverses -->

<!-- TOOLBOX -->
<div class="portal" id='p-tb'>
	<h5>Werkzeuge</h5>
	<div class="body">
		<ul>
			<li id="t-whatlinkshere"><a href="http://wiki.selfhtml.org/wiki/Spezial:Linkliste/PHP/Anwendung_und_Praxis/File_Upload" title="Liste aller Seiten, die hierher verlinken [j]" accesskey="j">Links auf diese Seite</a></li>
			<li id="t-recentchangeslinked"><a href="http://wiki.selfhtml.org/wiki/Spezial:Änderungen_an_verlinkten_Seiten/PHP/Anwendung_und_Praxis/File_Upload" title="Letzte Änderungen an Seiten, die von hier verlinkt sind [k]" accesskey="k">Änderungen an verlinkten Seiten</a></li>
			<li id="t-specialpages"><a href="http://wiki.selfhtml.org/wiki/Spezial:Spezialseiten" title="Liste aller Spezialseiten [q]" accesskey="q">Spezialseiten</a></li>
			<li><a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;printable=yes" rel="alternate">Druckversion</a></li>
			<li id="t-permalink"><a href="http://wiki.selfhtml.org/index.php?title=PHP/Anwendung_und_Praxis/File_Upload&amp;oldid=24607" title="Dauerhafter Link zu dieser Seitenversion">Permanenter Link</a></li>
<li id="t-smwbrowselink"><a href="http://wiki.selfhtml.org/wiki/Spezial:Durchsuchen/PHP-2FAnwendung_und_Praxis-2FFile_Upload" title="Spezial:Durchsuchen/PHP-2FAnwendung und Praxis-2FFile Upload">Attribute anzeigen</a></li>		</ul>
	</div>
</div>

<!-- /TOOLBOX -->

<!-- Flattr -->
<div class="portal" id='p-Flattr'>
	<h5>Flattr</h5>
	<div class="body">
		<ul><li><a href="https://flattr.com/thing/68982/SELFHTML-Wiki"><img border="0" title="zur Flattr-Seite des SELFHTML-Wiki" alt="Flattr this" src="http://wiki.selfhtml.org/extensions/Flattr/flattr-100x17.png" /></a><br />Was ist <a href="http://wiki.selfhtml.org/wiki/SELFHTML:Flattr" title="SELFHTML:Flattr">Flattr</a>?
</li></ul>
	</div>
</div>

<!-- /Flattr -->

<!-- Soziale Netzwerke -->
<div class="portal" id='p-Soziale_Netzwerke'>
	<h5>Soziale Netzwerke</h5>
	<div class="body">
		<ul>
			<li id="n-GitHub"><a href="https://github.com/selfhtml" rel="nofollow">GitHub</a></li>
			<li id="n-Twitter"><a href="https://twitter.com/selfhtml" rel="nofollow">Twitter</a></li>
			<li id="n-Flattr"><a href="https://flattr.com/thing/68982/SELFHTML-Wiki" rel="nofollow">Flattr</a></li>
			<li id="n-Trello"><a href="https://trello.com/selfhtml" rel="nofollow">Trello</a></li>
			<li id="n-spenden"><a href="http://selfhtml.org/spenden.html" rel="nofollow">spenden</a></li>
		</ul>
	</div>
</div>

<!-- /Soziale Netzwerke -->

<!-- SEARCH -->

<!-- /SEARCH -->

<!-- LANGUAGES -->

<!-- /LANGUAGES -->
			</div>
		<!-- /panel -->
		<!-- footer -->
		<div id="footer">
							<ul id="footer-info">
											<li id="footer-info-lastmod"> Diese Seite wurde zuletzt am 24. Dezember 2014 um 14:37 Uhr geändert.</li>
											<li id="footer-info-viewcount">Diese Seite wurde bisher 20.263-mal abgerufen.</li>
											<li id="footer-info-copyright"><div id="selfhtml-sponsor">
  <h2>Unterstützt durch</h2>
  <ul>
    <li><a href="http://www.eu.ntt.com/"><img src="http://src.selfhtml.org/wiki/ntt-logo.png" alt="NTT Communications - Europe"></a></li>
    <li><a href="http://www.manitu.de/"><img src="http://src.selfhtml.org/wiki/manitu-logo.png" alt="Manitu - Menschlich. Einfach besser."></a><img src="http://www.browser-statistik.de/browser.png?style=0" width="1" height="1" style="border: 0px;" alt=""></li>
  </ul>
</div>
<p>Die Inhalte des SELFHTML-Wikis unterliegen der <a class="external" href="http://creativecommons.org/licenses/by-sa/3.0/de/">CC-BY-SA 3.0 (de)</a>.<br/>
Nähere Informationen finden Sie unter <a href="http://wiki.selfhtml.org/wiki/SELFHTML-Wiki/Lizenzvereinbarungen">SELFHTML-Wiki/Lizenzvereinbarungen</a>.</p></li>
									</ul>
							<ul id="footer-places">
											<li id="footer-places-privacy"><a href="http://wiki.selfhtml.org/wiki/SELFHTML:Datenschutz" title="SELFHTML:Datenschutz">Datenschutz</a></li>
											<li id="footer-places-about"><a href="http://wiki.selfhtml.org/wiki/SELFHTML:Über_SELFHTML-Wiki" title="SELFHTML:Über SELFHTML-Wiki">Über SELFHTML-Wiki</a></li>
											<li id="footer-places-disclaimer"><a href="http://wiki.selfhtml.org/wiki/SELFHTML:Impressum" title="SELFHTML:Impressum">Impressum</a></li>
									</ul>
										<ul id="footer-icons" class="noprint">
					<li id="footer-copyrightico">
						<a href="http://creativecommons.org/licenses/by-sa/3.0/de/"><img src="http://src.selfhtml.org/cc-by-sa-88x31.png" alt="CC-BY-SA 3.0 (de)" width="88" height="31" /></a>
					</li>
					<li id="footer-poweredbyico">
						<a href="http://www.mediawiki.org/"><img src="http://wiki.selfhtml.org/skins/common/images/poweredby_mediawiki_88x31.png" alt="Powered by MediaWiki" width="88" height="31" /></a>
						<a href="http://www.semantic-mediawiki.org/wiki/Semantic_MediaWiki"><img src="http://wiki.selfhtml.org/extensions/SemanticMediaWiki/resources/images/smw_button.png" alt="Powered by Semantic MediaWiki" width="88" height="31" /></a>
					</li>
				</ul>
						<div style="clear:both"></div>
		</div>
		<!-- /footer -->
		<script src="http://wiki.selfhtml.org/load.php?debug=false&amp;lang=de-formal&amp;modules=skins.selfhtml%2Cvector&amp;only=scripts&amp;skin=selfhtml&amp;*"></script>
<script>if(window.mw){
mw.loader.load(["mediawiki.user","mediawiki.page.ready","mediawiki.legacy.mwsuggest","ext.vector.collapsibleNav","ext.vector.collapsibleTabs","ext.vector.simpleSearch"], null, true);
}</script>
<script src="http://wiki.selfhtml.org/load.php?debug=false&amp;lang=de-formal&amp;modules=site&amp;only=scripts&amp;skin=selfhtml&amp;*"></script>
<!-- Served in 0.118 secs. -->
	</body>

<!-- Mirrored from wiki.selfhtml.org/wiki/PHP/Anwendung_und_Praxis/File_Upload by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 01 Mar 2015 22:32:19 GMT -->
</html>
